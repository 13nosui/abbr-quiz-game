<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚ºï¼ˆã‚®ãƒ£ãƒ«èªãƒ¢ãƒ¼ãƒ‰æ­è¼‰ï¼‰</title>
    <style>
        /* ãƒ™ãƒ¼ã‚¹è¨­å®š */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --bg-color: #f0f4f8;
            --text-color: #333;
            
            /* ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ©ãƒ¼ */
            --gal-primary: #ff69b4;
            --gal-dark: #c71585;
            --gal-bg: #fff0f5;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s;
        }

        /* ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã */
        body.gal-mode {
            background-color: var(--gal-bg);
            --primary-color: var(--gal-primary);
            --primary-dark: var(--gal-dark);
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .screen { display: none; }
        .screen.active { 
            display: block; 
            animation: fadeIn 0.3s ease-out; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .menu-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin: 10px 0;
            padding: 1.2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            font-weight: bold;
            color: white;
            text-align: left;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-std { background-color: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-gal { background-color: #ff69b4; box-shadow: 0 4px 0 #c71585; }
        
        /* æ™‚ä»£é¸æŠãƒœã‚¿ãƒ³ */
        .era-btn {
            width: 100%;
            margin: 8px 0;
            padding: 1rem;
            font-size: 1rem;
            border-radius: 50px;
            border: 2px solid #ff69b4;
            background: white;
            color: #ff69b4;
            font-weight: bold;
            cursor: pointer;
        }
        .era-btn:hover { background: #fff0f5; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰é¸æŠ (4æŠ/å…¥åŠ›/ã¿ã‚“ãª) */
        .play-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .play-mode-btn {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .play-mode-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* å•é¡Œè¡¨ç¤ºéƒ¨ */
        .question-box {
            background-color: #eef2f7;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .badge {
            position: absolute;
            top: -10px;
            right: 10px;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .badge-level { background: #f1c40f; }
        .badge-era { background: #9b59b6; }

        .abbr-text {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.2;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .choice-btn {
            background-color: white;
            border: 2px solid #bdc3c7;
            color: #333;
            padding: 15px;
            font-size: 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
        }
        .choice-btn.correct-choice {
            background-color: var(--success-color) !important;
            color: white !important;
            border-color: var(--success-color) !important;
        }
        .choice-btn.wrong-choice {
            background-color: var(--error-color) !important;
            color: white !important;
            border-color: var(--error-color) !important;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 4px 0 var(--primary-dark);
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input[type="text"] {
            width: 100%;
            padding: 14px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary-color); }

        /* çµæœè¡¨ç¤º */
        .result-feedback-box {
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid #eee;
        }
        #result-message { font-size: 1.8rem; font-weight: bold; margin: 0.5rem 0; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            width: 100%;
            background-color: #eee;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */
        .back-link {
            display: inline-block;
            margin-top: 25px;
            color: #999;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 10px;
        }
        
        .toggle-desc { font-size: 0.8rem; color: #666; margin-bottom: 5px; }

        @media (max-width: 480px) {
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.3rem; }
            .abbr-text { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="app-title">ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚º</h1>
    <p class="subtitle" id="app-subtitle">ä¸€èˆ¬å¸¸è­˜ã‹ã‚‰ã‚®ãƒ£ãƒ«èªã¾ã§ï¼</p>

    <div id="menu-screen" class="screen active">
        
        <div style="margin-bottom: 20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <p class="toggle-desc">éŠã³æ–¹ã‚’é¸ã‚“ã§ã­</p>
            <div class="play-mode-selector">
                <button class="play-mode-btn selected" onclick="setPlayMode('choice', this)">ğŸ¤” 4æŠ</button>
                <button class="play-mode-btn" onclick="setPlayMode('solo', this)">âŒ¨ï¸ å…¥åŠ›</button>
                <button class="play-mode-btn" onclick="setPlayMode('party', this)">ğŸ—£ï¸ ã¿ã‚“ãª</button>
            </div>
        </div>

        <p style="margin-bottom: 1rem; font-weight:bold;">ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
        
        <button class="menu-btn btn-std" onclick="startStandardGame()">
            <div class="menu-btn-content">
                <span>ğŸ“˜ å®Ÿç”¨ãƒ»ä¸€èˆ¬ã‚³ãƒ¼ã‚¹</span>
                <span class="menu-desc" style="font-size:0.8rem; opacity:0.9;">ãƒ¬ãƒ™ãƒ«åˆ¥ã«å‡ºé¡Œï¼ˆå…¨50å•ã€œï¼‰</span>
            </div>
            <span class="menu-arrow">â–¶</span>
        </button>

        <button class="menu-btn btn-gal" onclick="toggleGalMenu()">
            <div class="menu-btn-content">
                <span>ğŸ’– ã‚®ãƒ£ãƒ«èªãƒ»æ­»èªã‚³ãƒ¼ã‚¹</span>
                <span class="menu-desc" style="font-size:0.8rem; opacity:0.9;">æ˜­å’Œãƒ»å¹³æˆãƒ»ä»¤å’Œã‚’é¸ã¹ã‚‹ã‚ˆ</span>
            </div>
            <span class="menu-arrow">â–¼</span>
        </button>
        
        <div id="gal-era-select" style="display:none; margin-top:10px; animation: fadeIn 0.3s;">
            <button class="era-btn" onclick="startGalGame('showa')">ğŸ“¼ æ˜­å’Œã‚®ãƒ£ãƒ«ï¼ˆãƒŠã‚¦ã„ï¼‰</button>
            <button class="era-btn" onclick="startGalGame('heisei')">ğŸŒº å¹³æˆã‚®ãƒ£ãƒ«ï¼ˆãƒãƒ§ãƒ™ãƒªã‚°ï¼‰</button>
            <button class="era-btn" onclick="startGalGame('reiwa')">ğŸ“± ä»¤å’Œã‚®ãƒ£ãƒ«ï¼ˆKPï¼‰</button>
        </div>

        <p style="font-size:0.8rem; color:#aaa; margin-top:20px;">â€»éŸ³ãŒå‡ºã¾ã™ ğŸ”ˆ</p>
    </div>

    <div id="game-screen" class="screen">
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <div class="question-box">
            <div id="info-badge" class="badge badge-level">LEVEL 1</div>
            <span class="label" id="question-label">ã“ã‚Œã®æ­£å¼åç§°ï¼ˆæ„å‘³ï¼‰ã¯ï¼Ÿ</span>
            <div id="question-text" class="abbr-text"></div>
        </div>

        <div id="choice-area" style="display:none;">
            <div id="choices-container" class="choices-container"></div>
        </div>

        <div id="solo-area" style="display:none;">
            <input type="text" id="answer-input" placeholder="ã“ã“ã«å…¥åŠ›..." autocomplete="off">
            <br>
            <button id="solo-submit-btn" class="action-btn" onclick="checkSoloAnswer()">å›ç­”ã™ã‚‹</button>
        </div>

        <div id="common-result-area" class="result-feedback-box" style="display:none;">
            <div id="result-message"></div>
            <div style="margin-top:10px;">
                æ­£è§£ã¯ï¼š<br><strong id="common-correct-text" style="font-size:1.3rem; color:#333;"></strong>
            </div>
            <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
        </div>

        <div id="party-area" style="display:none;">
            <button id="party-reveal-btn" class="action-btn" style="background-color:#e67e22; box-shadow: 0 4px 0 #d35400;" onclick="revealPartyAnswer()">æ­£è§£ã‚’è¦‹ã‚‹</button>
            <div id="party-answer-box" class="party-answer-box" style="display:none; margin:20px 0; border:2px dashed #ccc; padding:20px;">
                <div class="party-answer-text" id="party-correct-text" style="font-size:1.6rem; font-weight:bold; color:#e74c3c;"></div>
                <div class="party-sub-text" style="color:#777; margin-top:5px;">ï¼ˆä»–ï¼š<span id="party-alt-text"></span>ï¼‰</div>
                <br>
                <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <div class="back-link" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</div>
    </div>

    <div id="end-screen" class="screen">
        <h2 id="end-title">çµ‚äº†ï¼</h2>
        
        <div id="scored-end-area" style="display:none;">
            <p class="score-display" style="font-size:1.8rem; font-weight:bold; margin: 10px 0;">
                æ­£è§£æ•°: <span id="final-score">0</span> / <span id="total-count">0</span>
            </p>
            <div id="feedback-comment" style="margin: 1.5rem 0; font-size:1.1rem;"></div>
        </div>
        
        <div id="party-end-area" style="display:none;">
            <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>ç››ã‚Šä¸ŠãŒã‚Šã¾ã—ãŸã‹ï¼Ÿ</p>
        </div>

        <button class="action-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    /* --- éŸ³å£°å‡¦ç† --- */
    let audioCtx;
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSound(type) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.setValueAtTime(1760, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.4);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 0.4);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 0.3);
        }
    }

    /* --- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ --- */
    // type: 'std' (é€šå¸¸) ã¾ãŸã¯ 'gal' (ã‚®ãƒ£ãƒ«èª)
    const masterQuizData = [
        // === Level 1: åŸºç¤ (STD) ===
        { abbr: "ã‚¹ãƒãƒ›", formal: ["ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‘ã‚½ã‚³ãƒ³", formal: ["ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"], type: 'std', level: 1 },
        { abbr: "ã‚³ãƒ³ãƒ“ãƒ‹", formal: ["ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒ³ã‚¹ã‚¹ãƒˆã‚¢"], type: 'std', level: 1 },
        { abbr: "ãƒ†ãƒ¬ãƒ“", formal: ["ãƒ†ãƒ¬ãƒ“ã‚¸ãƒ§ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒªãƒ¢ã‚³ãƒ³", formal: ["ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼"], type: 'std', level: 1 },
        { abbr: "ã‚¨ã‚¢ã‚³ãƒ³", formal: ["ã‚¨ã‚¢ãƒ¼ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ¼"], type: 'std', level: 1 },
        { abbr: "ã‚¢ãƒ‹ãƒ¡", formal: ["ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‡ãƒ‘ãƒ¼ãƒˆ", formal: ["ãƒ‡ãƒ‘ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚¹ãƒˆã‚¢"], type: 'std', level: 1 },
        { abbr: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", formal: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ¼ã‚±ãƒƒãƒˆ"], type: 'std', level: 1 },
        { abbr: "ãƒã‚¤ãƒˆ", formal: ["ã‚¢ãƒ«ãƒã‚¤ãƒˆ"], type: 'std', level: 1 },
        { abbr: "ãƒ“ãƒ«", formal: ["ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°"], type: 'std', level: 1 },
        { abbr: "ãƒã‚¤ã‚¯", formal: ["ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ”ã‚¢ãƒ", formal: ["ãƒ”ã‚¢ãƒãƒ•ã‚©ãƒ«ãƒ†"], type: 'std', level: 1 },
        { abbr: "ãƒ¡ãƒ¢", formal: ["ãƒ¡ãƒ¢ãƒ©ãƒ³ãƒ€ãƒ "], type: 'std', level: 1 },
        { abbr: "ãƒŸã‚¹", formal: ["ãƒŸã‚¹ãƒ†ã‚¤ã‚¯"], type: 'std', level: 1 },
        { abbr: "ãƒ—ãƒ­", formal: ["ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«"], type: 'std', level: 1 },
        { abbr: "ã‚¢ãƒ—ãƒª", formal: ["ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"], type: 'std', level: 1 },
        { abbr: "ã‚¤ãƒ³ãƒ•ãƒ«", formal: ["ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶"], type: 'std', level: 1 },
        { abbr: "ãƒˆã‚¤ãƒ¬", formal: ["ãƒˆã‚¤ãƒ¬ãƒƒãƒˆ"], type: 'std', level: 1 },

        // === Level 2: ä¸­ç´š (STD) ===
        { abbr: "é£Ÿãƒ‘ãƒ³", formal: ["ä¸»é£Ÿç”¨ãƒ‘ãƒ³"], type: 'std', level: 2 },
        { abbr: "è»æ‰‹", formal: ["è»ç”¨æ‰‹è¢‹"], type: 'std', level: 2 },
        { abbr: "åˆ‡æ‰‹", formal: ["åˆ‡ç¬¦æ‰‹å½¢"], type: 'std', level: 2 },
        { abbr: "çµŒæ¸ˆ", formal: ["çµŒä¸–æ¸ˆæ°‘"], type: 'std', level: 2 },
        { abbr: "æ•™ç§‘æ›¸", formal: ["æ•™ç§‘ç”¨å›³æ›¸"], type: 'std', level: 2 },
        { abbr: "ãƒœãƒ¼ãƒ«ãƒšãƒ³", formal: ["ãƒœãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆãƒšãƒ³"], type: 'std', level: 2 },
        { abbr: "ã‚·ãƒ£ãƒ¼ãƒšãƒ³", formal: ["ã‚·ãƒ£ãƒ¼ãƒ—ãƒšãƒ³ã‚·ãƒ«"], type: 'std', level: 2 },
        { abbr: "æ¼”æ­Œ", formal: ["æ¼”èª¬æ­Œ"], type: 'std', level: 2 },
        { abbr: "å‰²ã‚Šå‹˜", formal: ["å‰²å‰å‹˜å®š"], type: 'std', level: 2 },
        { abbr: "æ–­ãƒˆãƒ„", formal: ["æ–­ç„¶ãƒˆãƒƒãƒ—"], type: 'std', level: 2 },
        { abbr: "ç‰¹æ€¥", formal: ["ç‰¹åˆ¥æ€¥è¡Œ"], type: 'std', level: 2 },
        { abbr: "å­¦å‰²", formal: ["å­¦ç”Ÿå‰²å¼•"], type: 'std', level: 2 },
        { abbr: "å›½é€£", formal: ["å›½éš›é€£åˆ"], type: 'std', level: 2 },
        { abbr: "è¾²å”", formal: ["è¾²æ¥­å”åŒçµ„åˆ"], type: 'std', level: 2 },
        { abbr: "äº¤ç•ª", formal: ["äº¤ç•ªæ‰€"], type: 'std', level: 2 },
        { abbr: "å°±æ´»", formal: ["å°±è·æ´»å‹•"], type: 'std', level: 2 },
        { abbr: "ãƒ–ãƒ­ã‚°", formal: ["ã‚¦ã‚§ãƒ–ãƒ­ã‚°"], type: 'std', level: 2 },
        { abbr: "ãƒªã‚¹ãƒˆãƒ©", formal: ["ãƒªã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°"], type: 'std', level: 2 },

        // === Level 3: ä¸Šç´š (STD) ===
        { abbr: "ã‚«ãƒ©ã‚ªã‚±", formal: ["ç©ºã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©"], type: 'std', level: 3 },
        { abbr: "ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³", formal: ["åœŸå£‡å ´ã‚­ãƒ£ãƒ³ã‚»ãƒ«"], type: 'std', level: 3 },
        { abbr: "ãƒ¬ãƒ¼ãƒ€ãƒ¼", formal: ["é›»æ³¢æ¢çŸ¥æ©Ÿ", "ãƒ©ã‚¸ã‚ªãƒ‡ã‚£ãƒ†ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°"], type: 'std', level: 3 },
        { abbr: "USB", formal: ["ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ»ã‚·ãƒªã‚¢ãƒ«ãƒ»ãƒã‚¹"], type: 'std', level: 3 },
        { abbr: "Wi-Fi", formal: ["ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹ãƒ»ãƒ•ã‚£ãƒ‡ãƒªãƒ†ã‚£"], type: 'std', level: 3 },
        { abbr: "DVD", formal: ["ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ãƒãƒ¼ã‚µã‚¿ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ã‚¹ã‚¯"], type: 'std', level: 3 },
        { abbr: "GPS", formal: ["ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ "], type: 'std', level: 3 },
        { abbr: "IQ", formal: ["ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹ãƒ»ã‚¯ã‚©ãƒ¼ã‚·ã‚§ãƒ³ãƒˆ", "çŸ¥èƒ½æŒ‡æ•°"], type: 'std', level: 3 },
        { abbr: "SOS", formal: ["é­é›£ä¿¡å·", "Save Our Souls"], type: 'std', level: 3 },
        { abbr: "VIP", formal: ["ãƒ™ãƒªãƒ¼ãƒ»ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ³ãƒˆãƒ»ãƒ‘ãƒ¼ã‚½ãƒ³"], type: 'std', level: 3 },
        { abbr: "ATM", formal: ["ç¾é‡‘è‡ªå‹•é ã‘æ‰•ã„æ©Ÿ", "ã‚ªãƒ¼ãƒˆãƒ¡ã‚¤ãƒ†ãƒƒãƒ‰ãƒ»ãƒ†ãƒ©ãƒ¼ãƒ»ãƒã‚·ãƒ³"], type: 'std', level: 3 },
        { abbr: "CEO", formal: ["æœ€é«˜çµŒå–¶è²¬ä»»è€…", "ãƒãƒ¼ãƒ•ãƒ»ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚ªãƒ•ã‚£ã‚µãƒ¼"], type: 'std', level: 3 },
        { abbr: "NG", formal: ["ãƒãƒ¼ã‚°ãƒƒãƒ‰"], type: 'std', level: 3 },
        { abbr: "CM", formal: ["ã‚³ãƒãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"], type: 'std', level: 3 },
        { abbr: "ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„", formal: ["ãƒ›ãƒ¯ã‚¤ãƒˆã‚·ãƒ£ãƒ„"], type: 'std', level: 3 },

        // === ã‚®ãƒ£ãƒ«èªãƒ»æ­»èªï¼šæ˜­å’Œ ===
        { abbr: "ãƒŠã‚¦ã„", formal: ["ç¾ä»£çš„", "æµè¡Œã—ã¦ã„ã‚‹", "ä»Šé¢¨"], type: 'gal', era: 'showa' },
        { abbr: "ãƒãƒ–ãƒ€ãƒ", formal: ["è¦ªå‹", "æœ¬å½“ã®å‹é”"], type: 'gal', era: 'showa' },
        { abbr: "ãƒ‰ãƒ­ãƒ³", formal: ["æ¶ˆãˆã‚‹", "å…ˆã«å¸°ã‚‹"], type: 'gal', era: 'showa' },
        { abbr: "ã‚¢ãƒƒã‚·ãƒ¼", formal: ["è¶³ä»£ã‚ã‚Šã®ç”·", "é€è¿ä¿‚"], type: 'gal', era: 'showa' },
        { abbr: "ãƒ¡ãƒƒã‚·ãƒ¼", formal: ["é£Ÿäº‹ã‚’å¥¢ã‚‰ã›ã‚‹ç”·"], type: 'gal', era: 'showa' },
        { abbr: "ãƒãƒªãƒãƒª", formal: ["ä¸€ç”Ÿæ‡¸å‘½", "ç¾å½¹"], type: 'gal', era: 'showa' },
        { abbr: "ãƒ€ã‚µã‚¤", formal: ["ç”°èˆãã•ã„"], type: 'gal', era: 'showa' },
        { abbr: "ãƒãƒ³ãƒ‘ãªã„", formal: ["åŠç«¯ã§ã¯ãªã„", "ã™ã”ã„"], type: 'gal', era: 'showa' },
        { abbr: "ã‚¤ã‚¿é£¯", formal: ["ã‚¤ã‚¿ãƒªã‚¢æ–™ç†"], type: 'gal', era: 'showa' },
        { abbr: "æœã‚·ãƒ£ãƒ³", formal: ["æœã®ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼"], type: 'gal', era: 'showa' },

        // === ã‚®ãƒ£ãƒ«èªãƒ»æ­»èªï¼šå¹³æˆ ===
        { abbr: "ãƒãƒ§ãƒ™ãƒªãƒ", formal: ["è¶…ãƒ™ãƒªãƒ¼ãƒãƒƒãƒ‰", "æœ€æ‚ª"], type: 'gal', era: 'heisei' },
        { abbr: "ãƒãƒ§ãƒ™ãƒªã‚°", formal: ["è¶…ãƒ™ãƒªãƒ¼ã‚°ãƒƒãƒ‰", "æœ€é«˜"], type: 'gal', era: 'heisei' },
        { abbr: "MK5", formal: ["ãƒã‚¸ã§ã‚­ãƒ¬ã‚‹5ç§’å‰"], type: 'gal', era: 'heisei' },
        { abbr: "KY", formal: ["ç©ºæ°—èª­ã‚ãªã„"], type: 'gal', era: 'heisei' },
        { abbr: "MM", formal: ["ãƒã‚¸ã‚€ã‹ã¤ã"], type: 'gal', era: 'heisei' },
        { abbr: "ã‚³ã‚®ãƒ£ãƒ«", formal: ["é«˜æ ¡ç”Ÿã‚®ãƒ£ãƒ«"], type: 'gal', era: 'heisei' },
        { abbr: "ã‚¢ã‚²ã½ã‚ˆ", formal: ["æ°—åˆ†ãŒä¸ŠãŒã£ã¦ã„ã‚‹", "ãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã„"], type: 'gal', era: 'heisei' },
        { abbr: "ã‚¬ãƒ³ã‚°ãƒ­", formal: ["é¡”ãŒé»’ã„", "æ—¥ç„¼ã‘ã‚®ãƒ£ãƒ«"], type: 'gal', era: 'heisei' },
        { abbr: "ãƒ‘ãƒªãƒ”", formal: ["ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ”ãƒ¼ãƒ—ãƒ«"], type: 'gal', era: 'heisei' },
        { abbr: "Bãƒ€ãƒƒã‚·ãƒ¥", formal: ["çŒ›ãƒ€ãƒƒã‚·ãƒ¥", "æ€¥ã"], type: 'gal', era: 'heisei' },

        // === ã‚®ãƒ£ãƒ«èªãƒ»æ­»èªï¼šä»¤å’Œï¼ˆZä¸–ä»£ï¼‰ ===
        { abbr: "KP", formal: ["ä¹¾æ¯"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚Š", formal: ["äº†è§£"], type: 'gal', era: 'reiwa' },
        { abbr: "ãƒ•ãƒ­ãƒªãƒ€", formal: ["ãŠé¢¨å‘‚ã«å…¥ã‚‹ã‹ã‚‰é›¢è„±ã™ã‚‹"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚¹ãƒ‘ãƒ€ãƒª", formal: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ€ãƒ¼ãƒªãƒ³", "ãƒã‚¤ã‚¹ãƒšãƒƒã‚¯ãªå½¼æ°"], type: 'gal', era: 'reiwa' },
        { abbr: "ãã¾Z", formal: ["æ°—ã¾ãšã„"], type: 'gal', era: 'reiwa' },
        { abbr: "è‰", formal: ["ç¬‘ã„", "é¢ç™½ã„"], type: 'gal', era: 'reiwa' },
        { abbr: "å¢æŠœã‘", formal: ["æ´—ç·´ã•ã‚Œã‚‹", "ãŠã—ã‚ƒã‚Œã«ãªã‚‹"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚ªã‚·ãƒ£ãƒ”ã‚¯", formal: ["ãŠã—ã‚ƒã‚Œãªãƒ”ã‚¯ãƒ‹ãƒƒã‚¯"], type: 'gal', era: 'reiwa' },
        { abbr: "ãƒ‡ã‚£ã‚¹ã‚‹", formal: ["ãƒ‡ã‚£ã‚¹ãƒšã‚¯ãƒˆã™ã‚‹", "ä¾®è¾±ã™ã‚‹"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚¿ãƒ”ã‚‹", formal: ["ã‚¿ãƒ”ã‚ªã‚«ã‚’é£²ã‚€"], type: 'gal', era: 'reiwa' }
    ];

    /* --- çŠ¶æ…‹å¤‰æ•° --- */
    let currentPlayMode = 'choice'; // choice, solo, party
    let currentCourse = 'std'; // std, gal
    let currentEra = ''; // showa, heisei, reiwa
    let currentQuestionIndex = 0;
    let score = 0;
    let activeQuestionList = []; 

    // DOMè¦ç´ 
    const menuScreen = document.getElementById('menu-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const progressBar = document.getElementById('progress-bar');
    const questionText = document.getElementById('question-text');
    const infoBadge = document.getElementById('info-badge');
    const commonResultArea = document.getElementById('common-result-area');
    const resultMessage = document.getElementById('result-message');
    const commonCorrectText = document.getElementById('common-correct-text');

    // ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆ4æŠ / å…¥åŠ› / ã¿ã‚“ãªï¼‰
    function setPlayMode(mode, btn) {
        currentPlayMode = mode;
        document.querySelectorAll('.play-mode-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    // ã‚®ãƒ£ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
    function toggleGalMenu() {
        const menu = document.getElementById('gal-era-select');
        menu.style.display = (menu.style.display === 'none') ? 'block' : 'none';
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆé€šå¸¸ï¼‰ ---
    function startStandardGame() {
        initAudio();
        currentCourse = 'std';
        document.body.classList.remove('gal-mode'); // ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰è§£é™¤
        
        // ãƒ¬ãƒ™ãƒ«åˆ¥ã«æŠ½å‡ºã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦çµåˆ
        const l1 = shuffleArray(masterQuizData.filter(q => q.type === 'std' && q.level === 1));
        const l2 = shuffleArray(masterQuizData.filter(q => q.type === 'std' && q.level === 2));
        const l3 = shuffleArray(masterQuizData.filter(q => q.type === 'std' && q.level === 3));
        activeQuestionList = [...l1, ...l2, ...l3];

        startGameCommon();
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆã‚®ãƒ£ãƒ«ï¼‰ ---
    function startGalGame(era) {
        initAudio();
        currentCourse = 'gal';
        currentEra = era;
        document.body.classList.add('gal-mode'); // ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰é©ç”¨

        // æ™‚ä»£åˆ¥ã«æŠ½å‡º
        activeQuestionList = shuffleArray(masterQuizData.filter(q => q.type === 'gal' && q.era === era));
        startGameCommon();
    }

    function startGameCommon() {
        currentQuestionIndex = 0;
        score = 0;
        menuScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸUIè¡¨ç¤ºåˆ¶å¾¡
        document.getElementById('choice-area').style.display = (currentPlayMode === 'choice') ? 'block' : 'none';
        document.getElementById('solo-area').style.display = (currentPlayMode === 'solo') ? 'block' : 'none';
        document.getElementById('party-area').style.display = (currentPlayMode === 'party') ? 'block' : 'none';

        showQuestion();
    }

    // --- å•é¡Œè¡¨ç¤º ---
    function showQuestion() {
        const q = activeQuestionList[currentQuestionIndex];
        questionText.textContent = q.abbr;

        // ãƒãƒƒã‚¸è¡¨ç¤º
        if (currentCourse === 'std') {
            infoBadge.className = 'badge badge-level';
            infoBadge.textContent = "LEVEL " + q.level;
            infoBadge.style.backgroundColor = (q.level===1)?"#27ae60":(q.level===2)?"#e67e22":"#e74c3c";
            document.getElementById('question-label').textContent = "ã“ã‚Œã®æ­£å¼åç§°ã¯ï¼Ÿ";
        } else {
            infoBadge.className = 'badge badge-era';
            const eraName = (q.era === 'showa') ? "æ˜­å’Œ" : (q.era === 'heisei') ? "å¹³æˆ" : "ä»¤å’Œ";
            infoBadge.textContent = eraName + "ã‚®ãƒ£ãƒ«";
            infoBadge.style.backgroundColor = "#c71585";
            document.getElementById('question-label').textContent = "ã“ã®è¨€è‘‰ã®æ„å‘³ã¯ï¼Ÿ";
        }

        const progress = (currentQuestionIndex / activeQuestionList.length) * 100;
        progressBar.style.width = `${progress}%`;
        commonResultArea.style.display = "none";
        document.getElementById('party-answer-box').style.display = "none";
        document.getElementById('party-reveal-btn').style.display = "inline-block";

        if (currentPlayMode === 'choice') setupChoiceMode(q);
        else if (currentPlayMode === 'solo') setupSoloMode();
        
        window.scrollTo(0,0);
    }

    // --- 4æŠãƒ¢ãƒ¼ãƒ‰ ---
    function setupChoiceMode(q) {
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        const correct = q.formal[0];

        // ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ç”Ÿæˆ
        // åŒã˜ã‚«ãƒ†ã‚´ãƒª(std/gal)ã®ä¸­ã‹ã‚‰æ­£è§£ä»¥å¤–ã®ç­”ãˆã‚’æŒã£ã¦ãã‚‹
        let sameTypePool = masterQuizData.filter(d => d.type === q.type);
        // ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãªã‚‰åŒã˜æ™‚ä»£ã®è¨€è‘‰ã‚’å„ªå…ˆã™ã‚‹ãŒã€è¶³ã‚Šãªã‘ã‚Œã°å…¨ã‚®ãƒ£ãƒ«èªã‹ã‚‰
        if(currentCourse === 'gal') {
            const eraPool = sameTypePool.filter(d => d.era === q.era);
            if(eraPool.length > 5) sameTypePool = eraPool; 
        }

        const dummyList = shuffleArray(sameTypePool.filter(d => d.formal[0] !== correct)).slice(0, 3);
        let choices = shuffleArray([correct, ...dummyList.map(d => d.formal[0])]);

        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = c;
            btn.onclick = () => checkChoice(c, btn, correct);
            container.appendChild(btn);
        });
    }

    function checkChoice(selected, btn, correct) {
        const btns = document.querySelectorAll('.choice-btn');
        btns.forEach(b => {
            b.disabled = true;
            if (b.textContent === correct) b.classList.add('correct-choice');
        });

        const isCorrect = (selected === correct);
        if(isCorrect) score++;
        else btn.classList.add('wrong-choice');
        
        showResult(isCorrect, correct);
    }

    // --- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ ---
    function setupSoloMode() {
        const input = document.getElementById('answer-input');
        input.value = "";
        input.disabled = false;
        const btn = document.getElementById('solo-submit-btn');
        btn.style.display = "inline-block";
        input.focus();
    }
    
    function normalize(str) {
        return str.replace(/[\sã€€ãƒ»]/g, "").toLowerCase();
    }

    function checkSoloAnswer() {
        const input = document.getElementById('answer-input');
        const userAns = normalize(input.value);
        const correctList = activeQuestionList[currentQuestionIndex].formal;
        const isCorrect = correctList.some(ans => normalize(ans) === userAns);
        
        input.disabled = true;
        document.getElementById('solo-submit-btn').style.display = "none";
        if(isCorrect) score++;
        showResult(isCorrect, correctList[0]);
    }

    // --- ã¿ã‚“ãªãƒ¢ãƒ¼ãƒ‰ ---
    function revealPartyAnswer() {
        const q = activeQuestionList[currentQuestionIndex];
        document.getElementById('party-correct-text').textContent = q.formal[0];
        document.getElementById('party-alt-text').textContent = (q.formal.length>1) ? q.formal.slice(1).join(', ') : "-";
        
        document.getElementById('party-reveal-btn').style.display = "none";
        document.getElementById('party-answer-box').style.display = "block";
        playSound('correct');
    }

    // --- çµæœè¡¨ç¤ºãƒ»åˆ†å² ---
    function showResult(isCorrect, ansText) {
        commonResultArea.style.display = "block";
        commonCorrectText.textContent = ansText;
        
        // ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ã¨é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤‰ãˆã‚‹
        if (isCorrect) {
            playSound('correct');
            resultMessage.className = "correct";
            if(currentCourse === 'gal') {
                const goods = ["ãƒã‚¤ãƒ–ã‚¹ä¸ŠãŒã‚‹ã€œï¼", "ã‚¦ã‚±ã‚‹w æ­£è§£ï¼", "å¤©æ‰ã™ãã‚“ï¼Ÿ", "ç¥ãƒ¬ãƒ™ãƒ«ï¼"];
                resultMessage.textContent = goods[Math.floor(Math.random()*goods.length)];
            } else {
                resultMessage.textContent = "æ­£è§£ï¼â­•ï¸";
            }
        } else {
            playSound('wrong');
            resultMessage.className = "incorrect";
            if(currentCourse === 'gal') {
                const bads = ["ã¾ã˜ãƒ ãƒª...", "ã‚µã‚²ã€œ...", "ã´ãˆã‚“ğŸ¥º", "ãƒ‰ãƒ³ãƒã‚¤ï¼"];
                resultMessage.textContent = bads[Math.floor(Math.random()*bads.length)];
            } else {
                resultMessage.textContent = "æ®‹å¿µ...âŒ";
            }
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < activeQuestionList.length) {
            showQuestion();
        } else {
            showEndScreen();
        }
    }

    function showEndScreen() {
        gameScreen.classList.remove('active');
        endScreen.classList.add('active');

        if (currentPlayMode !== 'party') {
            document.getElementById('scored-end-area').style.display = 'block';
            document.getElementById('party-end-area').style.display = 'none';
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-count').textContent = activeQuestionList.length;
            
            const fb = document.getElementById('feedback-comment');
            const rate = score / activeQuestionList.length;
            
            if (currentCourse === 'gal') {
                if(score === activeQuestionList.length) fb.textContent = "æœ€å¼·ã‚®ãƒ£ãƒ«èªå®šï¼ğŸ’–ğŸ‘‘";
                else if(rate >= 0.8) fb.textContent = "ãƒã‚¸ã§è©³ã—ãã¦è‰ww";
                else if(rate >= 0.5) fb.textContent = "ã„ã„æ„Ÿã˜ã˜ã‚ƒã‚“ï¼âœ¨";
                else fb.textContent = "ã‚‚ã£ã¨å‹‰å¼·ã—ãªï¼ğŸ‘Š";
            } else {
                if(score === activeQuestionList.length) fb.textContent = "å®Œç’§ã§ã™ï¼é›‘å­¦ç‹ï¼ğŸ‘‘";
                else if(rate >= 0.8) fb.textContent = "ã™ã”ã„ï¼ã‹ãªã‚Šè©³ã—ã„ã§ã™ã­ğŸ‘";
                else if(rate >= 0.5) fb.textContent = "ã¾ã‚ã¾ã‚ã§ã™ã­ï¼ğŸ‘";
                else fb.textContent = "ä¼¸ã³ä»£ãŒã‚ã‚Šã¾ã™ã­...ï¼ğŸŒ±";
            }
        } else {
            document.getElementById('scored-end-area').style.display = 'none';
            document.getElementById('party-end-area').style.display = 'block';
        }
    }

    // Enterã‚­ãƒ¼å¯¾å¿œ
    document.addEventListener("keypress", function(e) {
        if(e.key === "Enter" && currentPlayMode === 'solo') {
            const submitBtn = document.getElementById('solo-submit-btn');
            if(submitBtn.style.display !== 'none' && gameScreen.classList.contains('active')) {
                checkSoloAnswer();
            } else if(commonResultArea.style.display !== 'none') {
                nextQuestion();
            }
        }
    });

</script>
</body>
</html>
