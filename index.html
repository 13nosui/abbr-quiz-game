<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚ºï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰æ­è¼‰ç‰ˆï¼‰</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --bg-color: #f0f4f8;
            --text-color: #333;
            
            /* ã‚®ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ (Pink) */
            --gal-primary: #ff69b4;
            --gal-dark: #c71585;
            --gal-bg: #fff0f5;

            /* è­¦å¯Ÿãƒ¢ãƒ¼ãƒ‰ (Police Blue) */
            --police-primary: #2c3e50;
            --police-dark: #1a252f;
            --police-bg: #e8ecef;
            --police-accent: #f1c40f; /* ãƒãƒƒã‚¸ã®é‡‘ */

            /* ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ¼ãƒ‰ (Biz Navy) */
            --biz-primary: #0047AB; /* Cobalt Blue */
            --biz-dark: #003366;
            --biz-bg: #f5f7fa;

            /* ã‚ªã‚¿ã‚¯ãƒ¢ãƒ¼ãƒ‰ (Oshi Purple) */
            --otaku-primary: #9b59b6;
            --otaku-dark: #8e44ad;
            --otaku-bg: #f3e5f5;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s;
        }

        /* --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ†ãƒ¼ãƒé©ç”¨ --- */
        body.gal-mode {
            background-color: var(--gal-bg);
            --primary-color: var(--gal-primary);
            --primary-dark: var(--gal-dark);
        }
        body.police-mode {
            background-color: var(--police-bg);
            --primary-color: var(--police-primary);
            --primary-dark: var(--police-dark);
        }
        body.biz-mode {
            background-color: var(--biz-bg);
            --primary-color: var(--biz-primary);
            --primary-dark: var(--biz-dark);
        }
        body.otaku-mode {
            background-color: var(--otaku-bg);
            --primary-color: var(--otaku-primary);
            --primary-dark: var(--otaku-dark);
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        h1 { color: #2c3e50; margin-bottom: 0.5rem; font-size: 1.5rem; }
        .subtitle { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1.5rem; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin: 8px 0; padding: 1rem; font-size: 1rem;
            border-radius: 12px; border: none; cursor: pointer;
            transition: transform 0.1s; font-weight: bold; color: white;
            text-align: left; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-desc { font-size: 0.75rem; font-weight: normal; margin-top: 2px; opacity: 0.9; display:block; }

        /* ãƒœã‚¿ãƒ³è‰²è¨­å®š */
        .btn-std { background-color: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-gal { background-color: #ff69b4; box-shadow: 0 4px 0 #c71585; }
        .btn-police { background-color: #2c3e50; box-shadow: 0 4px 0 #1a252f; border-left: 5px solid #f1c40f; }
        .btn-biz { background-color: #0047AB; box-shadow: 0 4px 0 #003366; }
        .btn-otaku { background-color: #9b59b6; box-shadow: 0 4px 0 #8e44ad; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
        .play-mode-selector { display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .play-mode-btn {
            padding: 8px 14px; border: 1px solid #ccc; border-radius: 20px;
            background: white; cursor: pointer; font-size: 0.85rem;
        }
        .play-mode-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* ã‚®ãƒ£ãƒ«å¹´ä»£é¸æŠ */
        .era-btn {
            width: 100%; margin: 5px 0; padding: 0.8rem; font-size: 0.9rem;
            border-radius: 50px; border: 2px solid #ff69b4;
            background: white; color: #ff69b4; font-weight: bold; cursor: pointer;
        }

        /* å•é¡Œè¡¨ç¤º */
        .question-box {
            background-color: #eef2f7; padding: 1.5rem; border-radius: 10px;
            margin-bottom: 1.5rem; min-height: 140px; display: flex;
            flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        .badge {
            position: absolute; top: -10px; right: 10px; color: #fff;
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .abbr-text { font-size: 2.0rem; font-weight: bold; color: var(--primary-color); margin: 0; line-height: 1.2; }

        /* é¸æŠè‚¢ */
        .choices-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .choice-btn {
            background-color: white; border: 2px solid #bdc3c7; color: #333;
            padding: 14px; font-size: 0.95rem; border-radius: 10px;
            cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .choice-btn.correct-choice { background-color: var(--success-color) !important; color: white !important; border-color: var(--success-color) !important; }
        .choice-btn.wrong-choice { background-color: var(--error-color) !important; color: white !important; border-color: var(--error-color) !important; }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 14px 20px; font-size: 1.1rem; border-radius: 50px;
            cursor: pointer; font-weight: bold; width: 100%; max-width: 300px;
            box-shadow: 0 4px 0 var(--primary-dark); margin-top: 10px;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input[type="text"] {
            width: 100%; padding: 14px; font-size: 1.2rem; border: 2px solid #ddd;
            border-radius: 8px; margin-bottom: 1rem; text-align: center; outline: none;
        }
        
        /* çµæœè¡¨ç¤º */
        .result-feedback-box {
            background: #fafafa; padding: 20px; border-radius: 10px;
            margin-top: 10px; text-align: center; border: 1px solid #eee;
        }
        #result-message { font-size: 1.6rem; font-weight: bold; margin: 0.5rem 0; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }

        .progress-container { width: 100%; background-color: #eee; height: 6px; border-radius: 3px; margin-bottom: 1.5rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--success-color); width: 0%; transition: width 0.3s; }
        .back-link { display: inline-block; margin-top: 25px; color: #999; text-decoration: underline; cursor: pointer; font-size: 0.9rem; padding: 10px; }

        @media (max-width: 480px) {
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.3rem; }
            .abbr-text { font-size: 1.6rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="app-title">ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚º</h1>
    <p class="subtitle">ãã®è¨€è‘‰ã€æœ¬å½“ã®åå‰çŸ¥ã£ã¦ã‚‹ï¼Ÿ</p>

    <div id="menu-screen" class="screen active">
        
        <div style="margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">éŠã³æ–¹</p>
            <div class="play-mode-selector">
                <button class="play-mode-btn selected" onclick="setPlayMode('choice', this)">ğŸ¤” 4æŠ</button>
                <button class="play-mode-btn" onclick="setPlayMode('solo', this)">âŒ¨ï¸ å…¥åŠ›</button>
                <button class="play-mode-btn" onclick="setPlayMode('party', this)">ğŸ—£ï¸ ã¿ã‚“ãª</button>
            </div>
        </div>

        <div style="height: 300px; overflow-y: auto; padding-right: 5px;">
            <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">ã‚³ãƒ¼ã‚¹é¸æŠ</p>
            
            <button class="menu-btn btn-std" onclick="startSpecialGame('std')">
                <div class="menu-btn-content">
                    <span>ğŸ“˜ ä¸€èˆ¬å¸¸è­˜ã‚³ãƒ¼ã‚¹</span>
                    <span class="menu-desc">ã¾ãšã¯ã“ã“ã‹ã‚‰ï¼ãƒ¬ãƒ™ãƒ«åˆ¥å‡ºé¡Œ</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-police" onclick="startSpecialGame('police')">
                <div class="menu-btn-content">
                    <span>ğŸ‘® è­¦å¯Ÿãƒ»åˆ‘äº‹ãƒ‰ãƒ©ãƒ</span>
                    <span class="menu-desc">ã‚¬ã‚µå…¥ã‚Œã€ãƒ‡ã‚«ã€ãƒ›ã‚·...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-biz" onclick="startSpecialGame('biz')">
                <div class="menu-btn-content">
                    <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ»IT</span>
                    <span class="menu-desc">PDCAã€ASAPã€ãƒªã‚¹ã‚±...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-otaku" onclick="startSpecialGame('otaku')">
                <div class="menu-btn-content">
                    <span>ğŸ¤“ ã‚ªã‚¿ã‚¯ãƒ»æ¨ã—æ´»</span>
                    <span class="menu-desc">DDã€åŒæ‹…ã€ãƒªã‚¢ã‚¿ã‚¤...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-gal" onclick="toggleGalMenu()">
                <div class="menu-btn-content">
                    <span>ğŸ’– ã‚®ãƒ£ãƒ«èªãƒ»æ­»èª</span>
                    <span class="menu-desc">æ˜­å’Œãƒ»å¹³æˆãƒ»ä»¤å’Œã‚’é¸ã¹ã‚‹ã‚ˆ</span>
                </div>
                <span>â–¼</span>
            </button>
            
            <div id="gal-era-select" style="display:none; margin-top:5px; animation: fadeIn 0.3s;">
                <button class="era-btn" onclick="startGalGame('showa')">ğŸ“¼ æ˜­å’Œã‚®ãƒ£ãƒ«ï¼ˆãƒŠã‚¦ã„ï¼‰</button>
                <button class="era-btn" onclick="startGalGame('heisei')">ğŸŒº å¹³æˆã‚®ãƒ£ãƒ«ï¼ˆãƒãƒ§ãƒ™ãƒªã‚°ï¼‰</button>
                <button class="era-btn" onclick="startGalGame('reiwa')">ğŸ“± ä»¤å’Œã‚®ãƒ£ãƒ«ï¼ˆKPï¼‰</button>
            </div>
        </div>
        <p style="font-size:0.75rem; color:#aaa; margin-top:10px;">â€»éŸ³ãŒå‡ºã¾ã™ ğŸ”ˆ</p>
    </div>

    <div id="game-screen" class="screen">
        <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
        
        <div class="question-box">
            <div id="info-badge" class="badge" style="background:#ccc;">CATEGORY</div>
            <span class="label" id="question-label">ã“ã‚Œã®æ­£å¼åç§°ï¼ˆæ„å‘³ï¼‰ã¯ï¼Ÿ</span>
            <div id="question-text" class="abbr-text"></div>
        </div>

        <div id="choice-area" style="display:none;">
            <div id="choices-container" class="choices-container"></div>
        </div>

        <div id="solo-area" style="display:none;">
            <input type="text" id="answer-input" placeholder="ã“ã“ã«å…¥åŠ›..." autocomplete="off">
            <br>
            <button id="solo-submit-btn" class="action-btn" onclick="checkSoloAnswer()">å›ç­”ã™ã‚‹</button>
        </div>

        <div id="common-result-area" class="result-feedback-box" style="display:none;">
            <div id="result-message"></div>
            <div style="margin-top:10px;">
                æ­£è§£ã¯ï¼š<br><strong id="common-correct-text" style="font-size:1.3rem; color:#333;"></strong>
            </div>
            <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
        </div>

        <div id="party-area" style="display:none;">
            <button id="party-reveal-btn" class="action-btn" style="background-color:#e67e22; box-shadow: 0 4px 0 #d35400;" onclick="revealPartyAnswer()">æ­£è§£ã‚’è¦‹ã‚‹</button>
            <div id="party-answer-box" style="display:none; margin:20px 0; border:2px dashed #ccc; padding:20px;">
                <div id="party-correct-text" style="font-size:1.6rem; font-weight:bold; color:#e74c3c;"></div>
                <div style="color:#777; margin-top:5px;">ï¼ˆä»–ï¼š<span id="party-alt-text"></span>ï¼‰</div>
                <br>
                <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <div class="back-link" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</div>
    </div>

    <div id="end-screen" class="screen">
        <h2 id="end-title">çµ‚äº†ï¼</h2>
        <div id="scored-end-area">
            <p style="font-size:1.5rem; font-weight:bold;">æ­£è§£æ•°: <span id="final-score">0</span> / <span id="total-count">0</span></p>
            <div id="feedback-comment" style="margin: 1.5rem 0; font-size:1.1rem;"></div>
        </div>
        <button class="action-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    /* --- éŸ³å£°å‡¦ç† --- */
    let audioCtx;
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSound(type) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        if (type === 'correct') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        }
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now); osc.stop(now+0.4);
    }

    /* --- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ --- */
    const masterQuizData = [
        // === Level 1-3: Standard ===
        { abbr: "ã‚¹ãƒãƒ›", formal: ["ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‘ã‚½ã‚³ãƒ³", formal: ["ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"], type: 'std', level: 1 },
        { abbr: "é£Ÿãƒ‘ãƒ³", formal: ["ä¸»é£Ÿç”¨ãƒ‘ãƒ³"], type: 'std', level: 2 },
        { abbr: "è»æ‰‹", formal: ["è»ç”¨æ‰‹è¢‹"], type: 'std', level: 2 },
        { abbr: "ã‚«ãƒ©ã‚ªã‚±", formal: ["ç©ºã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©"], type: 'std', level: 3 },
        { abbr: "ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³", formal: ["åœŸå£‡å ´ã‚­ãƒ£ãƒ³ã‚»ãƒ«"], type: 'std', level: 3 },
        { abbr: "ãƒ¬ãƒ¼ãƒ€ãƒ¼", formal: ["é›»æ³¢æ¢çŸ¥æ©Ÿ"], type: 'std', level: 3 },
        
        // === ğŸ‘® è­¦å¯Ÿãƒ»åˆ‘äº‹ ===
        { abbr: "ã‚¬ã‚µå…¥ã‚Œ", formal: ["æœç´¢å·®æŠ¼", "å®¶å®…æœç´¢"], type: 'police' },
        { abbr: "ãƒ‡ã‚«", formal: ["åˆ‘äº‹"], type: 'police' },
        { abbr: "ãƒ›ã‚·", formal: ["çŠ¯äºº", "å®¹ç–‘è€…"], type: 'police' },
        { abbr: "ãƒãƒ³ã‹ã‘", formal: ["è·å‹™è³ªå•"], type: 'police' },
        { abbr: "ãƒãƒ«æš´", formal: ["çµ„ç¹”çŠ¯ç½ªå¯¾ç­–éƒ¨", "æš´åŠ›å›£æ‹…å½“"], type: 'police' },
        { abbr: "ã‚¬ã‚¤ã‚·ãƒ£", formal: ["è¢«å®³è€…"], type: 'police' },
        { abbr: "ãƒ¤ã‚µ", formal: ["å®¶", "éš ã‚Œå®¶"], type: 'police' },
        { abbr: "å¸³å ´", formal: ["æœæŸ»æœ¬éƒ¨"], type: 'police' },
        { abbr: "ç¾ç€", formal: ["ç¾å ´åˆ°ç€"], type: 'police' },
        { abbr: "ã‚²ã‚½", formal: ["è¶³è·¡", "é´"], type: 'police' },
        { abbr: "ãƒ­ã‚¯", formal: ["éºä½“", "æ­»ä½“"], type: 'police' },
        { abbr: "ãƒ©ã‚¸ã‚ª", formal: ["ç„¡ç·š", "ç„¡ç·šæ©Ÿ"], type: 'police' },
        { abbr: "åˆ¥ä»¶", formal: ["åˆ¥ä»¶é€®æ•"], type: 'police' },
        { abbr: "å®Œè½ã¡", formal: ["å®Œå…¨è‡ªä¾›"], type: 'police' },
        { abbr: "ã‚¿ã‚¿ã‚­", formal: ["å¼·ç›—"], type: 'police' },

        // === ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ»IT ===
        { abbr: "OJT", formal: ["On-the-Job Training", "å®Ÿå‹™æ•™è‚²"], type: 'biz' },
        { abbr: "PDCA", formal: ["Plan-Do-Check-Act"], type: 'biz' },
        { abbr: "ASAP", formal: ["As Soon As Possible", "ãªã‚‹ã¹ãæ—©ã"], type: 'biz' },
        { abbr: "ãƒªã‚¹ã‚±", formal: ["ãƒªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«", "æ—¥ç¨‹å¤‰æ›´"], type: 'biz' },
        { abbr: "MTG", formal: ["ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°", "ä¼šè­°"], type: 'biz' },
        { abbr: "KGI", formal: ["é‡è¦ç›®æ¨™é”æˆæŒ‡æ¨™", "Key Goal Indicator"], type: 'biz' },
        { abbr: "KPI", formal: ["é‡è¦æ¥­ç¸¾è©•ä¾¡æŒ‡æ¨™", "Key Performance Indicator"], type: 'biz' },
        { abbr: "B2B", formal: ["Business to Business", "ä¼æ¥­é–“å–å¼•"], type: 'biz' },
        { abbr: "CEO", formal: ["Chief Executive Officer", "æœ€é«˜çµŒå–¶è²¬ä»»è€…"], type: 'biz' },
        { abbr: "NR", formal: ["ãƒãƒ¼ãƒªã‚¿ãƒ¼ãƒ³", "ç›´å¸°"], type: 'biz' },
        { abbr: "ã‚¢ã‚¸ã‚§ãƒ³ãƒ€", formal: ["è­°é¡Œ", "è¡Œå‹•è¨ˆç”»"], type: 'biz' },
        { abbr: "ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹", formal: ["è¨¼æ‹ ", "æ ¹æ‹ "], type: 'biz' },
        { abbr: "ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹", formal: ["åˆæ„"], type: 'biz' },
        { abbr: "ã‚¢ã‚µã‚¤ãƒ³", formal: ["ä»»å‘½", "å‰²ã‚Šå½“ã¦"], type: 'biz' },

        // === ğŸ¤“ ã‚ªã‚¿ã‚¯ãƒ»æ¨ã—æ´» ===
        { abbr: "DD", formal: ["èª°ã§ã‚‚å¤§å¥½ã", "Daredemo Daisuki"], type: 'otaku' },
        { abbr: "åŒæ‹…", formal: ["åŒã˜æ‹…å½“", "åŒã˜æ¨ã—"], type: 'otaku' },
        { abbr: "BL", formal: ["ãƒœãƒ¼ã‚¤ã‚ºãƒ©ãƒ–"], type: 'otaku' },
        { abbr: "ãƒªã‚¢ã‚¿ã‚¤", formal: ["ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ "], type: 'otaku' },
        { abbr: "ã‚¹ãƒ‘ãƒãƒ£", formal: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆ", "æŠ•ã’éŠ­"], type: 'otaku' },
        { abbr: "ROMå°‚", formal: ["Read Only Member", "è¦‹ã‚‹ã ã‘"], type: 'otaku' },
        { abbr: "å¢", formal: ["ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"], type: 'otaku' },
        { abbr: "é¯–", formal: ["ã‚µãƒ¼ãƒãƒ¼"], type: 'otaku' },
        { abbr: "FFå¤–", formal: ["ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¤–"], type: 'otaku' },
        { abbr: "888", formal: ["ãƒ‘ãƒãƒ‘ãƒãƒ‘ãƒ", "æ‹æ‰‹"], type: 'otaku' },
        { abbr: "ã‚ªãƒ—ãƒãƒ£", formal: ["ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆ"], type: 'otaku' },
        { abbr: "ãƒªãƒ ã‚‹", formal: ["ãƒªãƒ ãƒ¼ãƒ–ã™ã‚‹", "ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤"], type: 'otaku' },
        { abbr: "ãƒã‚ºã‚‹", formal: ["Buzzã‚‹", "è©±é¡Œã«ãªã‚‹"], type: 'otaku' },

        // === ã‚®ãƒ£ãƒ«ãƒ»æ­»èª ===
        { abbr: "ãƒŠã‚¦ã„", formal: ["ç¾ä»£çš„"], type: 'gal', era: 'showa' },
        { abbr: "ãƒãƒ§ãƒ™ãƒªãƒ", formal: ["è¶…ãƒ™ãƒªãƒ¼ãƒãƒƒãƒ‰"], type: 'gal', era: 'heisei' },
        { abbr: "KP", formal: ["ä¹¾æ¯"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚Š", formal: ["äº†è§£"], type: 'gal', era: 'reiwa' },
        { abbr: "è‰", formal: ["ç¬‘ã„"], type: 'gal', era: 'reiwa' }
    ];

    /* --- çŠ¶æ…‹å¤‰æ•° --- */
    let currentPlayMode = 'choice'; 
    let currentType = 'std'; 
    let activeQuestionList = [];
    let currentQuestionIndex = 0;
    let score = 0;

    // DOMå–å¾—
    const menuScreen = document.getElementById('menu-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const questionText = document.getElementById('question-text');
    const infoBadge = document.getElementById('info-badge');

    function setPlayMode(mode, btn) {
        currentPlayMode = mode;
        document.querySelectorAll('.play-mode-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function toggleGalMenu() {
        const m = document.getElementById('gal-era-select');
        m.style.display = (m.style.display==='none')?'block':'none';
    }

    function shuffleArray(arr) {
        for(let i=arr.length-1; i>0; i--){
            const j=Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ (å…±é€š) ---
    function startSpecialGame(type) {
        initAudio();
        currentType = type;
        document.body.className = ''; // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
        
        // è‰²åˆ†ã‘
        if(type === 'police') document.body.classList.add('police-mode');
        else if(type === 'biz') document.body.classList.add('biz-mode');
        else if(type === 'otaku') document.body.classList.add('otaku-mode');
        else if(type === 'std') { /* default */ }

        // ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        if(type === 'std') {
            const l1 = shuffleArray(masterQuizData.filter(q=>q.type==='std'&&q.level===1));
            const l2 = shuffleArray(masterQuizData.filter(q=>q.type==='std'&&q.level===2));
            const l3 = shuffleArray(masterQuizData.filter(q=>q.type==='std'&&q.level===3));
            activeQuestionList = [...l1, ...l2, ...l3];
        } else {
            activeQuestionList = shuffleArray(masterQuizData.filter(q=>q.type===type));
        }
        startGameCommon();
    }

    function startGalGame(era) {
        initAudio();
        currentType = 'gal';
        document.body.className = 'gal-mode';
        activeQuestionList = shuffleArray(masterQuizData.filter(q=>q.type==='gal'&&q.era===era));
        startGameCommon();
    }

    function startGameCommon() {
        if(activeQuestionList.length === 0) { alert("å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        currentQuestionIndex = 0;
        score = 0;
        menuScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        document.getElementById('choice-area').style.display = (currentPlayMode==='choice')?'block':'none';
        document.getElementById('solo-area').style.display = (currentPlayMode==='solo')?'block':'none';
        document.getElementById('party-area').style.display = (currentPlayMode==='party')?'block':'none';
        
        showQuestion();
    }

    // --- å•é¡Œè¡¨ç¤º ---
    function showQuestion() {
        const q = activeQuestionList[currentQuestionIndex];
        questionText.textContent = q.abbr;
        
        // ãƒãƒƒã‚¸è¡¨ç¤º
        infoBadge.textContent = getBadgeText(q);
        infoBadge.style.backgroundColor = getBadgeColor(q);

        document.getElementById('progress-bar').style.width = `${(currentQuestionIndex/activeQuestionList.length)*100}%`;
        document.getElementById('common-result-area').style.display = "none";
        document.getElementById('party-answer-box').style.display = "none";
        document.getElementById('party-reveal-btn').style.display = "inline-block";

        if(currentPlayMode==='choice') setupChoiceMode(q);
        else if(currentPlayMode==='solo') setupSoloMode();
        window.scrollTo(0,0);
    }

    function getBadgeText(q) {
        if(currentType === 'std') return "LEVEL " + q.level;
        if(currentType === 'police') return "æœæŸ»è³‡æ–™";
        if(currentType === 'biz') return "Business Term";
        if(currentType === 'otaku') return "æ¨ã—ç”¨èª";
        if(currentType === 'gal') return "ã‚®ãƒ£ãƒ«èª";
        return "Q";
    }
    function getBadgeColor(q) {
        if(currentType === 'std') return (q.level===1)?"#27ae60":(q.level===2)?"#e67e22":"#e74c3c";
        if(currentType === 'police') return "#f1c40f"; // Gold
        if(currentType === 'biz') return "#003366";
        if(currentType === 'otaku') return "#8e44ad";
        return "#ff69b4";
    }

    // --- 4æŠ ---
    function setupChoiceMode(q) {
        const con = document.getElementById('choices-container');
        con.innerHTML = '';
        const correct = q.formal[0];
        // ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ï¼šåŒã˜ã‚¿ã‚¤ãƒ—ã®åˆ¥å•é¡Œã‹ã‚‰å–å¾—
        let pool = masterQuizData.filter(d=>d.type===q.type && d.formal[0]!==correct);
        if(pool.length < 3) pool = masterQuizData.filter(d=>d.formal[0]!==correct); // è¶³ã‚Šãªã‘ã‚Œã°å…¨ä½“ã‹ã‚‰

        const dummies = shuffleArray(pool).slice(0,3).map(d=>d.formal[0]);
        let choices = shuffleArray([correct, ...dummies]);

        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = c;
            btn.onclick = ()=>checkChoice(c, btn, correct);
            con.appendChild(btn);
        });
    }

    function checkChoice(sel, btn, cor) {
        document.querySelectorAll('.choice-btn').forEach(b=>{
            b.disabled=true;
            if(b.textContent===cor) b.classList.add('correct-choice');
        });
        const isCor = (sel===cor);
        if(isCor) score++;
        else btn.classList.add('wrong-choice');
        showResult(isCor, cor);
    }

    // --- å…¥åŠ› ---
    function setupSoloMode() {
        const inp = document.getElementById('answer-input');
        inp.value = ""; inp.disabled=false; inp.focus();
        document.getElementById('solo-submit-btn').style.display="inline-block";
    }
    function checkSoloAnswer() {
        const inp = document.getElementById('answer-input');
        const user = inp.value.replace(/[\sã€€ãƒ»]/g,"").toLowerCase();
        const cors = activeQuestionList[currentQuestionIndex].formal;
        const isCor = cors.some(c=>c.replace(/[\sã€€ãƒ»]/g,"").toLowerCase() === user);
        inp.disabled=true;
        document.getElementById('solo-submit-btn').style.display="none";
        if(isCor) score++;
        showResult(isCor, cors[0]);
    }

    // --- ã¿ã‚“ãª ---
    function revealPartyAnswer() {
        const q = activeQuestionList[currentQuestionIndex];
        document.getElementById('party-correct-text').textContent = q.formal[0];
        document.getElementById('party-alt-text').textContent = (q.formal.length>1)?q.formal.slice(1).join(', '):"-";
        document.getElementById('party-reveal-btn').style.display="none";
        document.getElementById('party-answer-box').style.display="block";
        playSound('correct');
    }

    // --- çµæœ ---
    function showResult(isCor, ans) {
        const area = document.getElementById('common-result-area');
        const msg = document.getElementById('result-message');
        const corTxt = document.getElementById('common-correct-text');
        area.style.display="block";
        corTxt.textContent = ans;

        if(isCor) {
            playSound('correct');
            msg.className = "correct";
            msg.textContent = getGoodMsg();
        } else {
            playSound('wrong');
            msg.className = "incorrect";
            msg.textContent = getBadMsg();
        }
    }

    function getGoodMsg() {
        if(currentType === 'police') return randomMsg(["ç¢ºä¿ï¼", "ãƒ›ã‚·ã‚’æŒ™ã’ãŸï¼", "ãŠæ‰‹æŸ„ã ï¼"]);
        if(currentType === 'biz') return randomMsg(["æ‰¿èªã—ã¾ã™", "ã‚¢ã‚°ãƒªãƒ¼ã§ã™", "ã‚¨ã‚¯ã‚»ãƒ¬ãƒ³ãƒˆ"]);
        if(currentType === 'otaku') return randomMsg(["å°Šã„...", "è§£é‡ˆä¸€è‡´ï¼", "ç¥ï¼"]);
        if(currentType === 'gal') return randomMsg(["ãƒã‚¤ãƒ–ã‚¹ä¸ŠãŒã‚‹ï¼", "ã‚¦ã‚±ã‚‹w æ­£è§£", "ç¥ãƒ¬ãƒ™ãƒ«ï¼"]);
        return "æ­£è§£ï¼â­•ï¸";
    }
    function getBadMsg() {
        if(currentType === 'police') return randomMsg(["èª¤èªé€®æ•...", "å–ã‚Šé€ƒãŒã—ãŸ...", "æœæŸ»ã‚„ã‚Šç›´ã—"]);
        if(currentType === 'biz') return randomMsg(["å´ä¸‹ã—ã¾ã™", "å†è€ƒã—ã¦ãã ã•ã„", "ãƒŠãƒ³ã‚»ãƒ³ã‚¹"]);
        if(currentType === 'otaku') return randomMsg(["ã«ã‚ã‹ä¹™", "è§£é‡ˆé•ã„", "å‡ºç›´ã—ã¦ãã¦"]);
        if(currentType === 'gal') return randomMsg(["ã¾ã˜ãƒ ãƒª...", "ã‚µã‚²ã€œ...", "ã´ãˆã‚“ğŸ¥º"]);
        return "æ®‹å¿µ...âŒ";
    }
    function randomMsg(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    function nextQuestion() {
        currentQuestionIndex++;
        if(currentQuestionIndex < activeQuestionList.length) showQuestion();
        else showEndScreen();
    }

    function showEndScreen() {
        gameScreen.classList.remove('active');
        endScreen.classList.add('active');
        if(currentPlayMode !== 'party') {
            document.getElementById('scored-end-area').style.display='block';
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-count').textContent = activeQuestionList.length;
            const fb = document.getElementById('feedback-comment');
            const rate = score/activeQuestionList.length;
            if(rate===1) fb.textContent = "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ä¼èª¬ç´šï¼ğŸ‘‘";
            else if(rate>=0.8) fb.textContent = "ç´ æ™´ã‚‰ã—ã„ï¼ãƒã‚¹ã‚¿ãƒ¼ç´šã§ã™ğŸ‘";
            else if(rate>=0.5) fb.textContent = "ã„ã„æ„Ÿã˜ã§ã™ï¼ğŸ‘";
            else fb.textContent = "ã¾ã ã¾ã ä¼¸ã³ä»£ãŒã‚ã‚Šã¾ã™ï¼ğŸŒ±";
        } else {
            document.getElementById('scored-end-area').style.display='none';
        }
    }

    document.addEventListener("keypress", (e)=>{
        if(e.key==="Enter" && currentPlayMode==='solo') {
            const btn = document.getElementById('solo-submit-btn');
            if(btn.style.display!=='none') checkSoloAnswer();
            else if(document.getElementById('common-result-area').style.display!=='none') nextQuestion();
        }
    });
</script>
</body>
</html>
