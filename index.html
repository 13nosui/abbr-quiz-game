<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚º</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        :root {
            --primary-color: #3498db; --bg-color: #f0f4f8; --text-color: #333;
            --success-color: #27ae60; --error-color: #e74c3c;
            --ai-primary: #8e44ad; --ai-bg: #f3e5f5;
            --gal-primary: #ff69b4; --gal-bg: #fff0f5;
            --police-primary: #2c3e50; --police-bg: #e8ecef;
            --biz-primary: #0047AB; --biz-bg: #f5f7fa;
            --otaku-primary: #9b59b6; --otaku-bg: #f3e5f5;
            --medical-primary: #16a085; --medical-bg: #e8f8f5;
            --netslang-primary: #e67e22; --netslang-bg: #fdf2e9;
            --sumo-primary: #8d6e63; --sumo-bg: #efebe9;
            --realestate-primary: #d35400; --realestate-bg: #fbeee6;
            --aviation-primary: #00a8ff; --aviation-bg: #e0f7fa;
            --school-primary: #2ecc71; --school-bg: #e8f8f5;
            --game-primary: #6c5ce7; --game-bg: #ede7f6;
            --media-primary: #e91e63; --media-bg: #fce4ec;
            --design-primary: #009688; --design-bg: #e0f2f1;
            /* é‡‘èã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ  */
            --finance-primary: #d4af37; --finance-bg: #fff9e6;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 10px;
            user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s;
        }

        /* ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        body.gal-mode { background-color: var(--gal-bg); --primary-color: var(--gal-primary); }
        body.police-mode { background-color: var(--police-bg); --primary-color: var(--police-primary); }
        body.biz-mode { background-color: var(--biz-bg); --primary-color: var(--biz-primary); }
        body.otaku-mode { background-color: var(--otaku-bg); --primary-color: var(--otaku-primary); }
        body.medical-mode { background-color: var(--medical-bg); --primary-color: var(--medical-primary); }
        body.netslang-mode { background-color: var(--netslang-bg); --primary-color: var(--netslang-primary); }
        body.sumo-mode { background-color: var(--sumo-bg); --primary-color: var(--sumo-primary); }
        body.realestate-mode { background-color: var(--realestate-bg); --primary-color: var(--realestate-primary); }
        body.aviation-mode { background-color: var(--aviation-bg); --primary-color: var(--aviation-primary); }
        body.school-mode { background-color: var(--school-bg); --primary-color: var(--school-primary); }
        body.game-mode { background-color: var(--game-bg); --primary-color: var(--game-primary); }
        body.media-mode { background-color: var(--media-bg); --primary-color: var(--media-primary); }
        body.design-mode { background-color: var(--design-bg); --primary-color: var(--design-primary); }
        body.finance-mode { background-color: var(--finance-bg); --primary-color: var(--finance-primary); }

        .container {
            background-color: white; padding: 2rem; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
            text-align: center; position: relative;
        }

        h1 { color: #2c3e50; margin-bottom: 0.5rem; font-size: 1.5rem; }
        .subtitle { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ãƒœã‚¿ãƒ³ */
        .menu-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin: 8px 0; padding: 1rem; font-size: 1rem;
            border-radius: 12px; border: none; cursor: pointer;
            transition: transform 0.1s; font-weight: bold; color: white;
            text-align: left; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-desc { font-size: 0.75rem; font-weight: normal; display:block; opacity:0.9; }

        .btn-std { background-color: #3498db; }
        .btn-police { background-color: #2c3e50; border-left: 5px solid #f1c40f; }
        .btn-biz { background-color: #0047AB; }
        .btn-otaku { background-color: #9b59b6; }
        .btn-gal { background-color: #ff69b4; }
        .btn-medical { background-color: #16a085; }
        .btn-netslang { background-color: #e67e22; }
        .btn-sumo { background-color: #8d6e63; border-left: 5px solid #000; }
        .btn-realestate { background-color: #d35400; }
        .btn-aviation { background-color: #00a8ff; }
        .btn-school { background-color: #2ecc71; }
        .btn-game { background-color: #6c5ce7; }
        .btn-media { background-color: #e91e63; }
        .btn-design { background-color: #009688; }
        .btn-finance { background-color: #d4af37; }
        .btn-create { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        .play-mode-selector { display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .play-mode-btn {
            padding: 8px 14px; border: 1px solid #ccc; border-radius: 20px;
            background: white; cursor: pointer; font-size: 0.85rem;
        }
        .play-mode-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .era-btn {
            width: 100%; margin: 5px 0; padding: 0.8rem; font-size: 0.9rem;
            border-radius: 50px; border: 2px solid #ff69b4;
            background: white; color: #ff69b4; font-weight: bold; cursor: pointer;
        }

        .question-box {
            background-color: #eef2f7; padding: 1.5rem; border-radius: 10px;
            margin-bottom: 1.5rem; min-height: 140px; display: flex;
            flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        .badge {
            position: absolute; top: -10px; right: 10px; color: #fff;
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .abbr-text { font-size: 2.0rem; font-weight: bold; color: var(--primary-color); margin: 0; line-height: 1.2; }

        .choices-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .choice-btn {
            background-color: white; border: 2px solid #bdc3c7; color: #333;
            padding: 14px; font-size: 0.95rem; border-radius: 10px;
            cursor: pointer; font-weight: bold; transition: all 0.2s;
            overflow-wrap: break-word; word-wrap: break-word;
        }
        .choice-btn.correct-choice { background-color: #27ae60 !important; color: white !important; border-color: #27ae60 !important; }
        .choice-btn.wrong-choice { background-color: #e74c3c !important; color: white !important; border-color: #e74c3c !important; }

        .action-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 14px 20px; font-size: 1.1rem; border-radius: 50px;
            cursor: pointer; font-weight: bold; width: 100%; max-width: 300px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); margin-top: 10px;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        input[type="text"], input[type="color"] {
            width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #ddd;
            border-radius: 8px; margin-bottom: 10px; outline: none;
        }
        
        .result-box {
            background: #fafafa; padding: 20px; border-radius: 10px;
            margin-top: 10px; text-align: center; border: 1px solid #eee; display: none;
        }
        #result-msg { font-size: 1.6rem; font-weight: bold; margin: 0.5rem 0; }
        .correct { color: #27ae60; } .incorrect { color: #e74c3c; }

        .progress-bar { width: 100%; background: #eee; height: 6px; border-radius: 3px; margin-bottom: 1.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: #27ae60; width: 0%; transition: width 0.3s; }
        
        .timer-bar { width: 100%; background: #f0f0f0; height: 8px; border-radius: 4px; margin-bottom: 1rem; overflow: hidden; position: relative; }
        .timer-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.1s linear; border-radius: 4px; }
        .timer-fill.warning { background: #f39c12; }
        .timer-fill.danger { background: #e74c3c; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .back-link { display: inline-block; margin-top: 25px; color: #999; text-decoration: underline; cursor: pointer; padding: 10px; }
        
        /* ä½œæˆç”»é¢ç”¨ */
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .q-input-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .remove-q-btn { background: #e74c3c; color: white; border:none; border-radius:4px; width:40px; cursor:pointer; }
        .loading-overlay { 
            position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9);
            display:none; justify-content:center; align-items:center; flex-direction:column; z-index:100;
        }

        /* ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç”¨ */
        .level-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .level-panel .level-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .level-panel .exp-text { font-size: 0.85rem; opacity: 0.9; margin-bottom: 8px; }
        .level-panel .level-progress { width: 100%; background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden; }
        .level-panel .level-progress-fill { height: 100%; background: #fff; width: 0%; transition: width 0.5s ease; }
        
        .exp-gain { color: #27ae60; font-weight: bold; font-size: 1.1rem; margin: 10px 0; }
        .level-up-animation {
            font-size: 2rem; font-weight: bold; color: #f39c12;
            animation: levelUp 1s ease-in-out;
            text-shadow: 0 0 10px rgba(243,156,18,0.5);
            margin: 15px 0;
        }
        .btn-share {
            background-color: #000;
            color: #fff;
            /* â˜…ä¿®æ­£: ä¸Šä¸‹15pxã€å·¦å³autoï¼ˆã“ã‚Œã§ä¸­å¤®ã«æ¥ã¾ã™ï¼‰ */
            margin: 15px auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px;
            /* å¿µã®ãŸã‚å¹…æŒ‡å®šã‚‚ç¶™æ‰¿ */
            width: 100%;
            max-width: 300px;
        }
        .btn-share:hover { opacity: 0.8; }
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; max-height: 80vh;
            border-radius: 16px; padding: 20px; text-align: center;
            overflow-y: auto; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .ranking-list { list-style: none; padding: 0; margin: 15px 0; text-align: left; }
        .ranking-item {
            display: flex; justify-content: space-between; padding: 10px;
            border-bottom: 1px solid #eee; font-size: 0.95rem;
        }
        .rank-num { font-weight: bold; width: 30px; color: #7f8c8d; }
        .rank-1 .rank-num { color: #f1c40f; font-size: 1.2rem; } /* 1ä½ã¯é‡‘ */
        .rank-2 .rank-num { color: #95a5a6; } /* 2ä½ã¯éŠ€ */
        .rank-3 .rank-num { color: #cd7f32; } /* 3ä½ã¯éŠ… */
        .rank-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rank-score { font-weight: bold; color: var(--primary-color); }
        
        /* ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  */
        .ranking-form { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .btn-rank { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }
        @keyframes levelUp {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 480px) {
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.3rem; }
            .abbr-text { font-size: 1.6rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="app-title">ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚º</h1>
    <p class="subtitle">å®Œå…¨ç‰ˆï¼ç„¡é™ã«éŠã¹ã‚‹ã‚ˆ</p>

    <div id="menu-screen" class="screen active">
        
        <div id="level-panel" class="level-panel">
            <div class="level-text">Lv. <span id="menu-level">1</span></div>
            <div class="exp-text">EXP: <span id="menu-exp">0</span> / <span id="menu-exp-needed">100</span></div>
            <div class="level-progress">
                <div id="menu-progress-fill" class="level-progress-fill"></div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">éŠã³æ–¹</p>
            <button class="menu-btn btn-rank" onclick="openRanking()" style="margin-bottom:15px;">
                <div class="menu-btn-content"><span>ğŸ† ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span><span class="menu-desc">ä¸Šä½ã‚’ç›®æŒ‡ãã†ï¼</span></div><span>ğŸ‘‘</span>
            </button>
            <div class="play-mode-selector">
                <button class="play-mode-btn selected" onclick="setPlayMode('choice', this)">ğŸ¤” 4æŠ</button>
                <button class="play-mode-btn" onclick="setPlayMode('solo', this)">âŒ¨ï¸ å…¥åŠ›</button>
                <button class="play-mode-btn" onclick="setPlayMode('party', this)">ğŸ—£ï¸ ã¿ã‚“ãª</button>
            </div>
        </div>

        <div style="height: 320px; overflow-y: auto; padding-right: 5px;">
            
            <button class="menu-btn btn-create" onclick="showCreateScreen()">
                <div class="menu-btn-content"><span>âœï¸ ã‚¯ã‚¤ã‚ºã‚’ä½œã‚‹ (Beta)</span><span class="menu-desc">ã¿ã‚“ãªã«å…¬é–‹ã—ã‚ˆã†</span></div><span>âœ¨</span>
            </button>
            
            <p style="font-size:0.9rem; font-weight:bold; margin:15px 0 5px;">ã‚³ãƒ¼ã‚¹é¸æŠ</p>

            <button class="menu-btn btn-std" onclick="startSpecialGame('std')">
                <div class="menu-btn-content"><span>ğŸ“˜ ä¸€èˆ¬å¸¸è­˜</span><span class="menu-desc">ãƒ¬ãƒ™ãƒ«é †ã«å‡ºé¡Œ</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-police" onclick="startSpecialGame('police')">
                <div class="menu-btn-content"><span>ğŸ‘® è­¦å¯Ÿãƒ»åˆ‘äº‹</span><span class="menu-desc">å…¬å¦¨ã€è·è³ª...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-biz" onclick="startSpecialGame('biz')">
                <div class="menu-btn-content"><span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ»IT</span><span class="menu-desc">MTGã€ã‚¢ã‚¸ã‚§ãƒ³ãƒ€...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-otaku" onclick="startSpecialGame('otaku')">
                <div class="menu-btn-content"><span>ğŸ¤“ ã‚ªã‚¿ã‚¯ãƒ»æ¨ã—æ´»</span><span class="menu-desc">å°Šã„ã€åŒæ‹…...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-gal" onclick="toggleGalMenu()">
                <div class="menu-btn-content"><span>ğŸ’– ã‚®ãƒ£ãƒ«èª</span><span class="menu-desc">æ˜­å’Œãƒ»å¹³æˆãƒ»ä»¤å’Œ</span></div><span>â–¼</span>
            </button>
            <button class="menu-btn btn-medical" onclick="startSpecialGame('medical')">
                <div class="menu-btn-content"><span>ğŸ¥ åŒ»ç™‚ãƒ»ç—…é™¢</span><span class="menu-desc">PTã€ER...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-netslang" onclick="startSpecialGame('netslang')">
                <div class="menu-btn-content"><span>ğŸ’» ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°</span><span class="menu-desc">BBSã€é¯–...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-sumo" onclick="startSpecialGame('sumo')">
                <div class="menu-btn-content"><span>âœ‹ ç›¸æ’²ãƒ»è§’ç•Œ</span><span class="menu-desc">ç•ªä»˜ã€æ¨ªå¯©...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-realestate" onclick="startSpecialGame('realestate')">
                <div class="menu-btn-content"><span>ğŸ  ä¸å‹•ç”£ãƒ»å»ºç¯‰</span><span class="menu-desc">LDKã€æ•·ç¤¼...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-aviation" onclick="startSpecialGame('aviation')">
                <div class="menu-btn-content"><span>âœˆï¸ èˆªç©ºãƒ»æ—…è¡Œ</span><span class="menu-desc">LCCã€CA...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-school" onclick="startSpecialGame('school')">
                <div class="menu-btn-content"><span>ğŸ« å­¦æ ¡ãƒ»æ•™è‚²</span><span class="menu-desc">PTAã€OB...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-game" onclick="startSpecialGame('game')">
                <div class="menu-btn-content"><span>ğŸ® ã‚²ãƒ¼ãƒ ç”¨èª</span><span class="menu-desc">RPGã€FPS...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-media" onclick="startSpecialGame('media')">
                <div class="menu-btn-content"><span>ğŸ“º ãƒ†ãƒ¬ãƒ“ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢</span><span class="menu-desc">CMã€AD...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-design" onclick="startSpecialGame('design')">
                <div class="menu-btn-content"><span>ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»åˆ¶ä½œ</span><span class="menu-desc">UI/UXã€CMYK...</span></div><span>â–¶</span>
            </button>
            <button class="menu-btn btn-finance" onclick="startSpecialGame('finance')">
                <div class="menu-btn-content"><span>ğŸ’° é‡‘èãƒ»æŠ•è³‡</span><span class="menu-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿</span></div><span>â–¶</span>
            </button>
            
            <div id="gal-era-select" style="display:none; margin-top:5px;">
                <button class="era-btn" onclick="startGalGame('showa')">ğŸ“¼ æ˜­å’Œã‚®ãƒ£ãƒ«</button>
                <button class="era-btn" onclick="startGalGame('heisei')">ğŸŒº å¹³æˆã‚®ãƒ£ãƒ«</button>
                <button class="era-btn" onclick="startGalGame('reiwa')">ğŸ“± ä»¤å’Œã‚®ãƒ£ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="create-screen" class="screen">
        <div class="loading-overlay" id="create-loading">
            <div style="font-weight:bold; margin-bottom:10px;">GitHubã«é€ä¿¡ä¸­...</div>
            <div style="font-size:0.8rem;">å®Œäº†ã™ã‚‹ã¨PRãŒä½œæˆã•ã‚Œã¾ã™</div>
        </div>

        <h2 style="color:#555; margin-bottom:15px;">ã‚¯ã‚¤ã‚ºã‚’ä½œã‚‹</h2>
        
        <div style="height:400px; overflow-y:auto; padding-right:5px; text-align:left;">
            <div class="input-group">
                <label>ã‚¸ãƒ£ãƒ³ãƒ«å (ä¾‹: å®‡å®™)</label>
                <input type="text" id="c-genre-name" placeholder="æ—¥æœ¬èªã§å…¥åŠ›">
            </div>
            <div class="input-group">
                <label>ã‚¸ãƒ£ãƒ³ãƒ«ID (ä¾‹: space)</label>
                <input type="text" id="c-genre-key" placeholder="è‹±å­—å°æ–‡å­—ã®ã¿" style="background:#f9f9f9;">
            </div>
            <div class="input-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>ãƒ¡ã‚¤ãƒ³è‰²</label>
                    <input type="color" id="c-color-p" value="#9b59b6" style="height:40px; padding:0;">
                </div>
                <div style="flex:1;">
                    <label>èƒŒæ™¯è‰²</label>
                    <input type="color" id="c-color-b" value="#f3e5f5" style="height:40px; padding:0;">
                </div>
            </div>

            <div class="input-group">
                <label>å•é¡Œãƒªã‚¹ãƒˆ (ç•¥èª / æ­£è§£)</label>
                <div id="q-input-container">
                    <div class="q-input-row">
                        <input type="text" placeholder="ç•¥èª" class="q-abbr" style="flex:1;">
                        <input type="text" placeholder="æ­£è§£" class="q-formal" style="flex:2;">
                    </div>
                    <div class="q-input-row">
                        <input type="text" placeholder="ç•¥èª" class="q-abbr" style="flex:1;">
                        <input type="text" placeholder="æ­£è§£" class="q-formal" style="flex:2;">
                    </div>
                </div>
                <button onclick="addQuestionRow()" style="background:#eee; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">+ è¿½åŠ </button>
            </div>
        </div>

        <button class="action-btn" onclick="submitQuizToGithub()" style="margin-top:10px;">GitHubã«é€ä¿¡</button>
        <div class="back-link" onclick="location.reload()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
    </div>

    <div id="game-screen" class="screen">
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div class="timer-bar" id="timer-bar" style="display:none;"><div id="timer-fill" class="timer-fill"></div></div>
        
        <div class="question-box">
            <div id="info-badge" class="badge" style="background:#ccc;">CATEGORY</div>
            <span class="label">ã“ã‚Œã®æ­£å¼åç§°ï¼ˆæ„å‘³ï¼‰ã¯ï¼Ÿ</span>
            <div id="question-text" class="abbr-text"></div>
        </div>

        <div id="choice-area" style="display:none;">
            <div id="choices-container" class="choices-container"></div>
        </div>

        <div id="solo-area" style="display:none;">
            <input type="text" id="answer-input" placeholder="ã“ã“ã«å…¥åŠ›..." autocomplete="off">
            <br>
            <button id="solo-submit-btn" class="action-btn" onclick="checkSoloAnswer()">å›ç­”ã™ã‚‹</button>
        </div>

        <div id="result-area" class="result-box" style="display:none;">
            <div id="result-msg"></div>
            <div style="margin-top:10px;">æ­£è§£ã¯ï¼š<br><strong id="correct-text" style="font-size:1.3rem;"></strong></div>
            <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
        </div>

        <div id="party-area" style="display:none;">
            <button id="party-reveal-btn" class="action-btn" style="background-color:#e67e22;" onclick="revealPartyAnswer()">æ­£è§£ã‚’è¦‹ã‚‹</button>
            <div id="party-answer-box" style="display:none; margin:20px 0; border:2px dashed #ccc; padding:20px;">
                <div id="party-correct-text" style="font-size:1.6rem; font-weight:bold; color:#e74c3c;"></div>
                <div style="color:#777;">ï¼ˆä»–ï¼š<span id="party-alt-text"></span>ï¼‰</div>
                <br>
                <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <div class="back-link" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</div>
    </div>

    <div id="end-screen" class="screen">
        <h2>çµ‚äº†ï¼</h2>
        <div id="scored-end-area">
            <p style="font-size:1.5rem; font-weight:bold;">æ­£è§£æ•°: <span id="final-score">0</span> / <span id="total-count">0</span></p>
            <div id="exp-gain-display" class="exp-gain" style="display:none;">ç²å¾—çµŒé¨“å€¤: +<span id="exp-gained">0</span> EXP</div>
            <div id="level-up-display" class="level-up-animation" style="display:none;">LEVEL UP!</div>
            <div style="margin: 15px 0;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Lv. <span id="end-level">1</span> (EXP: <span id="end-exp">0</span> / <span id="end-exp-needed">100</span>)</div>
                <div class="level-progress" style="background: #eee;">
                    <div id="end-progress-fill" class="level-progress-fill" style="background: #27ae60;"></div>
                </div>
            </div>
        </div>
        
        <button class="action-btn btn-share" onclick="shareResultOnX()">
            <span>ğ• ã§çµæœã‚’ãƒã‚¹ãƒˆã™ã‚‹</span>
        </button>
        <div class="ranking-form" id="register-area">
            <p style="font-size:0.9rem; margin-bottom:5px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹</p>
            <div style="display:flex; gap:5px;">
                <input type="text" id="player-name" placeholder="åå‰ (8æ–‡å­—ä»¥å†…)" maxlength="8" style="margin:0; flex:1;">
                <button class="action-btn" onclick="registerScore()" style="margin:0; width:auto; font-size:0.9rem; padding:10px 15px;">é€ä¿¡</button>
            </div>
        </div>
        <button class="action-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
</div>
<div id="ranking-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="close-btn" onclick="closeRanking()">Ã—</div>
        <h2 style="margin-top:0; color:#f39c12;">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <div id="ranking-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        <ul id="ranking-list" class="ranking-list"></ul>
        <button class="action-btn" onclick="closeRanking()">é–‰ã˜ã‚‹</button>
    </div>
</div>
<script>
    let audioCtx;
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
    function playSound(type) {
        if(!audioCtx) return; const now=audioCtx.currentTime; const osc=audioCtx.createOscillator(); const gain=audioCtx.createGain();
        if(type==='correct'){ osc.type='sine'; osc.frequency.setValueAtTime(880,now); osc.frequency.setValueAtTime(1760,now+0.1); gain.gain.linearRampToValueAtTime(0,now+0.4); }
        else{ osc.type='sawtooth'; osc.frequency.setValueAtTime(150,now); gain.gain.linearRampToValueAtTime(0,now+0.3); }
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now); osc.stop(now+0.4);
    }

    /* --- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå¾©æ´»ï¼ˆå®Œå…¨ç‰ˆãƒ»ä¿®æ­£æ¸ˆã¿ï¼‰ --- */
    const masterQuizData = [
        // STD
        { abbr: "ã‚¹ãƒãƒ›", formal: ["ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‘ã‚½ã‚³ãƒ³", formal: ["ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"], type: 'std', level: 1 },
        { abbr: "ã‚³ãƒ³ãƒ“ãƒ‹", formal: ["ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒ³ã‚¹ã‚¹ãƒˆã‚¢"], type: 'std', level: 1 },
        { abbr: "ãƒ†ãƒ¬ãƒ“", formal: ["ãƒ†ãƒ¬ãƒ“ã‚¸ãƒ§ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒªãƒ¢ã‚³ãƒ³", formal: ["ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼"], type: 'std', level: 1 },
        { abbr: "ã‚¨ã‚¢ã‚³ãƒ³", formal: ["ã‚¨ã‚¢ãƒ¼ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ¼"], type: 'std', level: 1 },
        { abbr: "ã‚¢ãƒ‹ãƒ¡", formal: ["ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‡ãƒ‘ãƒ¼ãƒˆ", formal: ["ãƒ‡ãƒ‘ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚¹ãƒˆã‚¢"], type: 'std', level: 1 },
        { abbr: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", formal: ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ¼ã‚±ãƒƒãƒˆ"], type: 'std', level: 1 },
        { abbr: "ãƒã‚¤ãƒˆ", formal: ["ã‚¢ãƒ«ãƒã‚¤ãƒˆ"], type: 'std', level: 1 },
        { abbr: "é£Ÿãƒ‘ãƒ³", formal: ["ä¸»é£Ÿç”¨ãƒ‘ãƒ³"], type: 'std', level: 2 },
        { abbr: "è»æ‰‹", formal: ["è»ç”¨æ‰‹è¢‹"], type: 'std', level: 2 },
        { abbr: "åˆ‡æ‰‹", formal: ["åˆ‡ç¬¦æ‰‹å½¢"], type: 'std', level: 2 },
        { abbr: "çµŒæ¸ˆ", formal: ["çµŒä¸–æ¸ˆæ°‘"], type: 'std', level: 2 },
        { abbr: "æ•™ç§‘æ›¸", formal: ["æ•™ç§‘ç”¨å›³æ›¸"], type: 'std', level: 2 },
        { abbr: "ãƒœãƒ¼ãƒ«ãƒšãƒ³", formal: ["ãƒœãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆãƒšãƒ³"], type: 'std', level: 2 },
        { abbr: "ã‚«ãƒ©ã‚ªã‚±", formal: ["ç©ºã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©"], type: 'std', level: 3 },
        { abbr: "ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³", formal: ["åœŸå£‡å ´ã‚­ãƒ£ãƒ³ã‚»ãƒ«"], type: 'std', level: 3 },
        { abbr: "ãƒ¬ãƒ¼ãƒ€ãƒ¼", formal: ["Radio Detection and Ranging", "ãƒ¬ãƒ¼ãƒ€ãƒ¼"], type: 'std', level: 3 },
        { abbr: "USB", formal: ["Universal Serial Bus", "ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚·ãƒªã‚¢ãƒ«ãƒã‚¹"], type: 'std', level: 3 },
        { abbr: "Wi-Fi", formal: ["Wireless Fidelity", "ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹ãƒ•ã‚£ãƒ‡ãƒªãƒ†ã‚£"], type: 'std', level: 3 },
        { abbr: "DVD", formal: ["Digital Versatile Disc", "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚µã‚¿ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯"], type: 'std', level: 3 },
        
        // POLICE (éš èªã‚’å‰Šé™¤ã—ã€ç•¥èªã¸åˆ·æ–°)
        { abbr: "å…¬å¦¨", formal: ["å…¬å‹™åŸ·è¡Œå¦¨å®³"], type: 'police', level: 1 },
        { abbr: "è·è³ª", formal: ["è·å‹™è³ªå•"], type: 'police', level: 1 },
        { abbr: "ãƒ‘ãƒˆã‚«ãƒ¼", formal: ["ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ã‚«ãƒ¼"], type: 'police', level: 1 },
        { abbr: "äº¤ç•ª", formal: ["äº¤ç•ªæ‰€"], type: 'police', level: 1 },
        { abbr: "åœ°æ¤œ", formal: ["åœ°æ–¹æ¤œå¯Ÿåº"], type: 'police', level: 2 },
        { abbr: "å®¶è£", formal: ["å®¶åº­è£åˆ¤æ‰€"], type: 'police', level: 2 },
        { abbr: "ç§‘æœç ”", formal: ["ç§‘å­¦æœæŸ»ç ”ç©¶æ‰€"], type: 'police', level: 2 },
        { abbr: "ç”Ÿå®‰", formal: ["ç”Ÿæ´»å®‰å…¨èª²"], type: 'police', level: 2 },
        { abbr: "æœä¸€", formal: ["æœæŸ»ç¬¬ä¸€èª²"], type: 'police', level: 3 },
        { abbr: "æ©Ÿæœ", formal: ["æ©Ÿå‹•æœæŸ»éšŠ"], type: 'police', level: 3 },
        { abbr: "é‘‘è­˜", formal: ["é‘‘è­˜èª²"], type: 'police', level: 3 },
        { abbr: "ä»»åŒ", formal: ["ä»»æ„åŒè¡Œ"], type: 'police', level: 3 },

        // BIZ
        { abbr: "MTG", formal: ["Meeting", "ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°"], type: 'biz', level: 1 },
        { abbr: "CEO", formal: ["Chief Executive Officer", "ãƒãƒ¼ãƒ•ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ•ã‚£ã‚µãƒ¼"], type: 'biz', level: 1 },
        { abbr: "NG", formal: ["No Good", "ãƒãƒ¼ã‚°ãƒƒãƒ‰"], type: 'biz', level: 1 },
        { abbr: "ã‚¢ãƒ", formal: ["ã‚¢ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ³ãƒˆ"], type: 'biz', level: 1 },
        { abbr: "OJT", formal: ["On-the-Job Training", "ã‚ªãƒ³ã‚¶ã‚¸ãƒ§ãƒ–ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°"], type: 'biz', level: 2 },
        { abbr: "PDCA", formal: ["Plan-Do-Check-Act", "ãƒ—ãƒ©ãƒ³ãƒ‰ã‚¥ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¯ãƒˆ"], type: 'biz', level: 2 },
        { abbr: "ASAP", formal: ["As Soon As Possible", "ã‚¢ã‚ºã‚¹ãƒ¼ãƒ³ã‚¢ã‚ºãƒãƒƒã‚·ãƒ–ãƒ«"], type: 'biz', level: 2 },
        { abbr: "ãƒªã‚¹ã‚±", formal: ["ãƒªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"], type: 'biz', level: 2 },
        { abbr: "KGI", formal: ["Key Goal Indicator", "ã‚­ãƒ¼ã‚´ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼"], type: 'biz', level: 3 },
        { abbr: "KPI", formal: ["Key Performance Indicator", "ã‚­ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼"], type: 'biz', level: 3 },
        { abbr: "NR", formal: ["No Return", "ãƒãƒ¼ãƒªã‚¿ãƒ¼ãƒ³"], type: 'biz', level: 3 },
        { abbr: "BtoB", formal: ["Business to Business", "ãƒ“ã‚¸ãƒã‚¹ãƒˆã‚¥ãƒ“ã‚¸ãƒã‚¹"], type: 'biz', level: 3 },

        // OTAKU
        { abbr: "BL", formal: ["Boys Love", "ãƒœãƒ¼ã‚¤ã‚ºãƒ©ãƒ–"], type: 'otaku', level: 1 },
        { abbr: "å¢", formal: ["ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"], type: 'otaku', level: 1 },
        { abbr: "æ¨ã—", formal: ["ä¸€æ¨ã—ã®ãƒ¡ãƒ³ãƒãƒ¼"], type: 'otaku', level: 1 },
        { abbr: "DD", formal: ["èª°ã§ã‚‚å¤§å¥½ã"], type: 'otaku', level: 2 },
        { abbr: "åŒæ‹…", formal: ["åŒã˜æ‹…å½“"], type: 'otaku', level: 2 },
        { abbr: "ãƒªã‚¢ã‚¿ã‚¤", formal: ["ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ "], type: 'otaku', level: 2 },
        { abbr: "ã‚¹ãƒ‘ãƒãƒ£", formal: ["Super Chat", "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆ"], type: 'otaku', level: 2 },
        { abbr: "ROMå°‚", formal: ["Read Only Member", "ãƒªãƒ¼ãƒ‰ã‚ªãƒ³ãƒªãƒ¼ãƒ¡ãƒ³ãƒãƒ¼"], type: 'otaku', level: 3 },
        { abbr: "FFå¤–", formal: ["ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¤–"], type: 'otaku', level: 3 },

        // GAL (ã‚¹ãƒ©ãƒ³ã‚°ãƒ»æ“¬éŸ³ã‚’å‰Šé™¤ã—ã€ç•¥èªã¸å·®ã—æ›¿ãˆ)
        { abbr: "ãƒœãƒ‡ã‚£ã‚³ãƒ³", formal: ["ãƒœãƒ‡ã‚£ã‚³ãƒ³ã‚·ãƒ£ã‚¹"], type: 'gal', era: 'showa' },
        { abbr: "ãƒ¯ãƒ³ãƒ¬ãƒ³", formal: ["ãƒ¯ãƒ³ãƒ¬ãƒ³ã‚°ã‚¹"], type: 'gal', era: 'showa' },
        { abbr: "æœã‚·ãƒ£ãƒ³", formal: ["æœã‚·ãƒ£ãƒ³ãƒ—ãƒ¼"], type: 'gal', era: 'showa' },
        { abbr: "ãƒãƒ§ãƒ™ãƒªãƒ", formal: ["è¶…ãƒ™ãƒªãƒ¼ãƒãƒƒãƒ‰"], type: 'gal', era: 'heisei' },
        { abbr: "ãƒãƒ§ãƒ™ãƒªã‚°", formal: ["è¶…ãƒ™ãƒªãƒ¼ã‚°ãƒƒãƒ‰"], type: 'gal', era: 'heisei' },
        { abbr: "MK5", formal: ["ãƒã‚¸ã§ã‚­ãƒ¬ã‚‹5ç§’å‰"], type: 'gal', era: 'heisei' },
        { abbr: "KP", formal: ["ä¹¾æ¯"], type: 'gal', era: 'reiwa' },
        { abbr: "ã‚Š", formal: ["äº†è§£"], type: 'gal', era: 'reiwa' },
        { abbr: "ãƒ•ãƒ­ãƒªãƒ€", formal: ["é¢¨å‘‚ã«å…¥ã‚‹ã®ã§é›¢è„±ã™ã‚‹"], type: 'gal', era: 'reiwa' },

        // MEDICAL (éš èªãƒ»åŸèªãã®ã‚‚ã®ã‚’å‰Šé™¤)
        { abbr: "ã‚¤ãƒ³ãƒ•ãƒ«", formal: ["ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶"], type: 'medical', level: 1 },
        { abbr: "ãƒªãƒãƒ“ãƒª", formal: ["ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"], type: 'medical', level: 1 },
        { abbr: "PT", formal: ["Physical Therapist", "ç†å­¦ç™‚æ³•å£«"], type: 'medical', level: 1 },
        { abbr: "ER", formal: ["Emergency Room", "æ•‘æ€¥æ•‘å‘½å®¤"], type: 'medical', level: 1 },
        { abbr: "ICU", formal: ["Intensive Care Unit", "ã‚¤ãƒ³ãƒ†ãƒ³ã‚·ãƒ–ã‚±ã‚¢ãƒ¦ãƒ‹ãƒƒãƒˆ"], type: 'medical', level: 2 },
        { abbr: "AED", formal: ["Automated External Defibrillator", "ã‚ªãƒ¼ãƒˆãƒ¡ã‚¤ãƒ†ãƒƒãƒ‰ã‚¨ã‚¯ã‚¹ã‚¿ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ•ã‚£ãƒ–ãƒªãƒ¬ãƒ¼ã‚¿ãƒ¼"], type: 'medical', level: 2 },
        { abbr: "MRI", formal: ["Magnetic Resonance Imaging", "ãƒã‚°ãƒãƒ†ã‚£ãƒƒã‚¯ãƒ¬ã‚¾ãƒŠãƒ³ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ³ã‚°"], type: 'medical', level: 2 },
        { abbr: "QOL", formal: ["Quality of Life", "ã‚¯ã‚ªãƒªãƒ†ã‚£ã‚ªãƒ–ãƒ©ã‚¤ãƒ•"], type: 'medical', level: 2 },
        { abbr: "ã‚¢ãƒŠãƒ ãƒ", formal: ["Anamnese", "ã‚¢ãƒŠãƒ ãƒãƒ¼ã‚¼"], type: 'medical', level: 3 },
        { abbr: "ãƒã‚¤ã‚¿ãƒ«", formal: ["Vital Signs", "ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³"], type: 'medical', level: 3 },
        { abbr: "EBM", formal: ["Evidence Based Medicine", "ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ¡ãƒ‡ã‚£ã‚¹ãƒ³"], type: 'medical', level: 3 },
        { abbr: "CT", formal: ["Computed Tomography", "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ãƒƒãƒ‰ãƒˆãƒ¢ã‚°ãƒ©ãƒ•ã‚£ãƒ¼"], type: 'medical', level: 3 },

        // NET SLANG (ç¿»è¨³ãƒ»ãã®ã¾ã¾ã‚’å‰Šé™¤)
        { abbr: "SNS", formal: ["Social Networking Service", "ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹"], type: 'netslang', level: 1 },
        { abbr: "ã‚¢ã‚«", formal: ["ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"], type: 'netslang', level: 1 },
        { abbr: "DM", formal: ["Direct Message", "ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"], type: 'netslang', level: 1 },
        { abbr: "w", formal: ["ç¬‘ã„"], type: 'netslang', level: 1 },
        { abbr: "kwsk", formal: ["è©³ã—ã"], type: 'netslang', level: 2 },
        { abbr: "wktk", formal: ["ãƒ¯ã‚¯ãƒ¯ã‚¯ãƒ†ã‚«ãƒ†ã‚«"], type: 'netslang', level: 2 },
        { abbr: "é¯–", formal: ["ã‚µãƒ¼ãƒãƒ¼"], type: 'netslang', level: 2 },
        { abbr: "DL", formal: ["Download", "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"], type: 'netslang', level: 2 },
        { abbr: "ggrks", formal: ["ã‚°ã‚°ã‚Œã‚«ã‚¹"], type: 'netslang', level: 3 },
        { abbr: "ã†p", formal: ["ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"], type: 'netslang', level: 3 },
        { abbr: "ä¹™", formal: ["ãŠç–²ã‚Œæ§˜"], type: 'netslang', level: 3 },
        { abbr: "BBS", formal: ["Bulletin Board System", "é›»å­æ²ç¤ºæ¿"], type: 'netslang', level: 3 },

        // SUMO (æ¥­ç•Œç”¨èªã‚’å‰Šé™¤ã—ã€æ­£å¼ç•¥èªã¸åˆ·æ–°)
        { abbr: "å ´æ‰€", formal: ["æœ¬å ´æ‰€"], type: 'sumo', level: 1 },
        { abbr: "å”ä¼š", formal: ["æ—¥æœ¬ç›¸æ’²å”ä¼š"], type: 'sumo', level: 1 },
        { abbr: "å›½æŠ€é¤¨", formal: ["ä¸¡å›½å›½æŠ€é¤¨"], type: 'sumo', level: 1 },
        { abbr: "å¼“å–ã‚Š", formal: ["å¼“å–ã‚Šå¼"], type: 'sumo', level: 1 },
        { abbr: "ç•ªä»˜", formal: ["ç•ªä»˜è¡¨"], type: 'sumo', level: 2 },
        { abbr: "æ¨ªå¯©", formal: ["æ¨ªç¶±å¯©è­°å§”å“¡ä¼š"], type: 'sumo', level: 2 },
        { abbr: "å·¡æ¥­", formal: ["åœ°æ–¹å·¡æ¥­"], type: 'sumo', level: 2 },
        { abbr: "åˆå ´æ‰€", formal: ["å¤§ç›¸æ’²ä¸€æœˆå ´æ‰€"], type: 'sumo', level: 2 },
        { abbr: "æ˜¥å ´æ‰€", formal: ["å¤§ç›¸æ’²ä¸‰æœˆå ´æ‰€"], type: 'sumo', level: 3 },
        { abbr: "å¤å ´æ‰€", formal: ["å¤§ç›¸æ’²äº”æœˆå ´æ‰€"], type: 'sumo', level: 3 },
        { abbr: "ç§‹å ´æ‰€", formal: ["å¤§ç›¸æ’²ä¹æœˆå ´æ‰€"], type: 'sumo', level: 3 },
        { abbr: "ä¹å·å ´æ‰€", formal: ["å¤§ç›¸æ’²åä¸€æœˆå ´æ‰€"], type: 'sumo', level: 3 },

        // REAL ESTATE
        { abbr: "LDK", formal: ["Living Dining Kitchen", "ãƒªãƒ“ãƒ³ã‚°ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ã‚­ãƒƒãƒãƒ³"], type: 'realestate', level: 1 },
        { abbr: "RC", formal: ["Reinforced Concrete", "ãƒ¬ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ã‚¹ãƒ‰ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ"], type: 'realestate', level: 1 },
        { abbr: "æ•·ç¤¼", formal: ["æ•·é‡‘ãƒ»ç¤¼é‡‘"], type: 'realestate', level: 1 },
        { abbr: "1R", formal: ["One Room", "ãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ "], type: 'realestate', level: 2 },
        { abbr: "UB", formal: ["Unit Bath", "ãƒ¦ãƒ‹ãƒƒãƒˆãƒã‚¹"], type: 'realestate', level: 2 },
        { abbr: "WIC", formal: ["Walk-in Closet", "ã‚¦ã‚©ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ"], type: 'realestate', level: 2 },
        // AVIATION
        { abbr: "LCC", formal: ["Low Cost Carrier", "ãƒ­ãƒ¼ã‚³ã‚¹ãƒˆã‚­ãƒ£ãƒªã‚¢"], type: 'aviation', level: 1 },
        { abbr: "CA", formal: ["Cabin Attendant", "ã‚­ãƒ£ãƒ“ãƒ³ã‚¢ãƒ†ãƒ³ãƒ€ãƒ³ãƒˆ"], type: 'aviation', level: 1 },
        { abbr: "ETA", formal: ["Estimated Time of Arrival"], type: 'aviation', level: 2 },
        { abbr: "GH", formal: ["Ground Handling", "ã‚°ãƒ©ãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"], type: 'aviation', level: 2 },
        { abbr: "ç¾½ç”°", formal: ["æ±äº¬å›½éš›ç©ºæ¸¯"], type: 'aviation', level: 2 },
        { abbr: "æˆç”°", formal: ["æˆç”°å›½éš›ç©ºæ¸¯"], type: 'aviation', level: 2 },
        { abbr: "ANA", formal: ["All Nippon Airways", "ã‚ªãƒ¼ãƒ«ãƒ‹ãƒƒãƒãƒ³ã‚¨ã‚¢ã‚¦ã‚§ã‚¤ã‚º"], type: 'aviation', level: 2 },
        { abbr: "JAL", formal: ["Japan Airlines", "ã‚¸ãƒ£ãƒ‘ãƒ³ã‚¨ã‚¢ãƒ©ã‚¤ãƒ³ã‚º"], type: 'aviation', level: 2 },
        // SCHOOL
        { abbr: "PTA", formal: ["Parent-Teacher Association", "ãƒšã‚¢ãƒ¬ãƒ³ãƒˆãƒ†ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³"], type: 'school', level: 1 },
        { abbr: "HR", formal: ["Home Room", "ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "], type: 'school', level: 1 },
        { abbr: "OB", formal: ["Old Boy", "ã‚ªãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ã‚¤"], type: 'school', level: 1 },
        { abbr: "AOå…¥è©¦", formal: ["Admissions Officeå…¥è©¦", "ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ•ã‚£ã‚¹å…¥è©¦"], type: 'school', level: 2 },
        { abbr: "TT", formal: ["Team Teaching", "ãƒãƒ¼ãƒ ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°"], type: 'school', level: 2 },
        // GAME
        { abbr: "RPG", formal: ["Role Playing Game", "ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°ã‚²ãƒ¼ãƒ "], type: 'game', level: 1 },
        { abbr: "FPS", formal: ["First Person Shooter", "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ã‚½ãƒ³ã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼"], type: 'game', level: 1 },
        { abbr: "NPC", formal: ["Non Player Character", "ãƒãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼"], type: 'game', level: 2 },
        { abbr: "HP", formal: ["Hit Point", "ãƒ’ãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆ"], type: 'game', level: 1 },
        { abbr: "RTA", formal: ["Real Time Attack", "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯"], type: 'game', level: 2 },
        // MEDIA
        { abbr: "CM", formal: ["Commercial Message", "ã‚³ãƒãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"], type: 'media', level: 1 },
        { abbr: "AD", formal: ["Assistant Director", "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼"], type: 'media', level: 1 },
        { abbr: "OA", formal: ["On Air", "ã‚ªãƒ³ã‚¨ã‚¢"], type: 'media', level: 1 },
        { abbr: "å®Œãƒ‘ã‚±", formal: ["å®Œå…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸"], type: 'media', level: 2 },
        { abbr: "F1å±¤", formal: ["Female 1", "ãƒ•ã‚£ãƒ¼ãƒ¡ã‚¤ãƒ«ãƒ¯ãƒ³"], type: 'media', level: 2 },
        // DESIGN
        { abbr: "UI", formal: ["User Interface", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"], type: 'design', level: 1 },
        { abbr: "UX", formal: ["User Experience", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹"], type: 'design', level: 1 },
        { abbr: "DTP", formal: ["Desktop Publishing", "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ³ã‚°"], type: 'design', level: 1 },
        { abbr: "RGB", formal: ["Red Green Blue", "ãƒ¬ãƒƒãƒ‰ã‚°ãƒªãƒ¼ãƒ³ãƒ–ãƒ«ãƒ¼"], type: 'design', level: 1 },
        { abbr: "CMYK", formal: ["Cyan Magenta Yellow Key plate", "ã‚·ã‚¢ãƒ³ãƒã‚¼ãƒ³ã‚¿ã‚¤ã‚¨ãƒ­ãƒ¼ã‚­ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆ"], type: 'design', level: 2 },
        { abbr: "DPI", formal: ["Dots Per Inch", "ãƒ‰ãƒƒãƒˆãƒ‘ãƒ¼ã‚¤ãƒ³ãƒ"], type: 'design', level: 2 },
        { abbr: "JPEG", formal: ["Joint Photographic Experts Group", "ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒ•ã‚©ãƒˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒ„ã‚°ãƒ«ãƒ¼ãƒ—"], type: 'design', level: 2 },
        { abbr: "PNG", formal: ["Portable Network Graphics", "ãƒãƒ¼ã‚¿ãƒ–ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹"], type: 'design', level: 2 },
        { abbr: "SVG", formal: ["Scalable Vector Graphics", "ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãƒ™ã‚¯ã‚¿ãƒ¼ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹"], type: 'design', level: 3 },
        { abbr: "CSS", formal: ["Cascading Style Sheets", "ã‚«ã‚¹ã‚±ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ"], type: 'design', level: 3 },
        { abbr: "PDF", formal: ["Portable Document Format", "ãƒãƒ¼ã‚¿ãƒ–ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"], type: 'design', level: 3 },

        // é‡‘èãƒ»æŠ•è³‡ (User Submitted)
        { abbr: "NISA", formal: ["Nippon Individual Savings Account"], type: 'finance', level: 1 },
        { abbr: "IPO", formal: ["Initial Public Offering"], type: 'finance', level: 1 },
        { abbr: "FX", formal: ["Foreign Exchange"], type: 'finance', level: 1 },
        { abbr: "GDP", formal: ["Gross Domestic Product"], type: 'finance', level: 1 },
        { abbr: "ETF", formal: ["Exchange Traded Fund"], type: 'finance', level: 1 },
        { abbr: "REIT", formal: ["Real Estate Investment Trust"], type: 'finance', level: 1 },
        { abbr: "VC", formal: ["Venture Capital"], type: 'finance', level: 1 },
        { abbr: "ROE", formal: ["Return On Equity"], type: 'finance', level: 1 },
        { abbr: "TOPIX", formal: ["Tokyo Stock Price Index"], type: 'finance', level: 1 },
        { abbr: "GAFA", formal: ["Google Apple Facebook Amazon"], type: 'finance', level: 1 }
    ];

    let currentPlayMode='choice', currentType='std', activeQuestionList=[], currentQuestionIndex=0, score=0;
    let timerInterval=null, timerRemaining=10;
    
    // ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
    let userLevel=1, currentExp=0;
    
    // localStorageã‹ã‚‰ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadUserLevel() {
        const savedLevel = localStorage.getItem('userLevel');
        const savedExp = localStorage.getItem('currentExp');
        if(savedLevel) userLevel = parseInt(savedLevel);
        if(savedExp) currentExp = parseInt(savedExp);
        updateLevelUI();
    }
    
    // localStorageã«ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveUserLevel() {
        localStorage.setItem('userLevel', userLevel);
        localStorage.setItem('currentExp', currentExp);
    }
    
    // ãƒ¬ãƒ™ãƒ«UIã‚’æ›´æ–°ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰
    function updateLevelUI() {
        const expNeeded = userLevel * 100;
        const progress = (currentExp / expNeeded) * 100;
        
        document.getElementById('menu-level').textContent = userLevel;
        document.getElementById('menu-exp').textContent = currentExp;
        document.getElementById('menu-exp-needed').textContent = expNeeded;
        document.getElementById('menu-progress-fill').style.width = progress + '%';
    }
    
    // çµŒé¨“å€¤ã‚’è¿½åŠ ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
    function addExp(gainedExp) {
        let totalExp = currentExp + gainedExp;
        let leveledUp = false;
        
        while(true) {
            const expNeeded = userLevel * 100;
            if(totalExp >= expNeeded) {
                totalExp -= expNeeded;
                userLevel++;
                leveledUp = true;
            } else {
                break;
            }
        }
        
        currentExp = totalExp;
        saveUserLevel();
        return { leveledUp, gainedExp };
    }
    
    // çµæœç”»é¢ã®ãƒ¬ãƒ™ãƒ«UIã‚’æ›´æ–°
    function updateEndLevelUI(expGained, leveledUp) {
        const expNeeded = userLevel * 100;
        const progress = (currentExp / expNeeded) * 100;
        
        document.getElementById('end-level').textContent = userLevel;
        document.getElementById('end-exp').textContent = currentExp;
        document.getElementById('end-exp-needed').textContent = expNeeded;
        document.getElementById('end-progress-fill').style.width = progress + '%';
        
        // ç²å¾—çµŒé¨“å€¤è¡¨ç¤º
        if(expGained > 0) {
            document.getElementById('exp-gained').textContent = expGained;
            document.getElementById('exp-gain-display').style.display = 'block';
        }
        
        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆå°‘ã—é…å»¶ã•ã›ã¦æ´¾æ‰‹ã«ï¼‰
        if(leveledUp) {
            setTimeout(() => {
                document.getElementById('level-up-display').style.display = 'block';
                playSound('correct'); // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³
            }, 300);
        }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    loadUserLevel();

    const menuScreen=document.getElementById('menu-screen'), gameScreen=document.getElementById('game-screen'), endScreen=document.getElementById('end-screen'), createScreen=document.getElementById('create-screen');
    
    function setPlayMode(mode, btn) {
        currentPlayMode=mode; document.querySelectorAll('.play-mode-btn').forEach(b=>b.classList.remove('selected')); btn.classList.add('selected');
    }
    function toggleGalMenu() {
        const m=document.getElementById('gal-era-select');
        if(m.style.display==='none'){ m.style.display='block'; setTimeout(()=>m.scrollIntoView({behavior:"smooth",block:"nearest"}),50); }
        else m.style.display='none';
    }
    function shuffleArray(arr) { for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function startSpecialGame(type) {
        initAudio(); currentType=type; document.body.className = type+'-mode';
        const target = masterQuizData.filter(q=>q.type===type);
        activeQuestionList = shuffleArray(target).slice(0,10);
        if(activeQuestionList.length===0) activeQuestionList=masterQuizData.slice(0,5);
        startGameCommon();
    }
    function startGalGame(era) {
        initAudio(); currentType='gal'; document.body.className='gal-mode';
        const target = masterQuizData.filter(q=>q.type==='gal'&&q.era===era);
        activeQuestionList = shuffleArray(target).slice(0,10);
        startGameCommon();
    }

    function startGameCommon() {
        currentQuestionIndex=0; score=0;
        stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        menuScreen.classList.remove('active'); endScreen.classList.remove('active'); createScreen.classList.remove('active');
        gameScreen.classList.add('active');
        document.getElementById('choice-area').style.display=(currentPlayMode==='choice')?'block':'none';
        document.getElementById('solo-area').style.display=(currentPlayMode==='solo')?'block':'none';
        document.getElementById('party-area').style.display=(currentPlayMode==='party')?'block':'none';
        
        // çµæœç”»é¢ã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('exp-gain-display').style.display='none';
        document.getElementById('level-up-display').style.display='none';
        
        showQuestion();
    }

    function showQuestion() {
        const q=activeQuestionList[currentQuestionIndex];
        document.getElementById('question-text').textContent = q.abbr;
        
        const badge=document.getElementById('info-badge');
        badge.textContent = (q.level?"LEVEL "+q.level : (q.era==='showa'?"æ˜­å’Œ":q.era==='heisei'?"å¹³æˆ":"ä»¤å’Œ"));
        badge.style.background = 
            (currentType==='police')?"#f1c40f": 
            (currentType==='gal')?"#ff69b4": 
            (currentType==='biz')?"#003366": 
            (currentType==='otaku')?"#9b59b6": 
            (currentType==='medical')?"#16a085": 
            (currentType==='netslang')?"#e67e22": 
            (currentType==='sumo')?"#8d6e63": 
            (currentType==='realestate')?"#d35400": 
            (currentType==='aviation')?"#00a8ff": 
            (currentType==='school')?"#2ecc71": 
            (currentType==='game')?"#6c5ce7": 
            (currentType==='media')?"#e91e63":
            (currentType==='design')?"#009688": 
            (currentType==='finance')?"#d4af37":
            "#27ae60";
        
        document.getElementById('progress-fill').style.width = `${(currentQuestionIndex/activeQuestionList.length)*100}%`;
        document.getElementById('result-area').style.display="none";
        document.getElementById('party-answer-box').style.display="none";
        document.getElementById('party-reveal-btn').style.display="inline-block";

        if(currentPlayMode==='choice') setupChoice(q);
        else if(currentPlayMode==='solo') setupSolo();
        
        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆPartyãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ï¼‰
        if(currentPlayMode!=='party') {
            startTimer();
        } else {
            stopTimer();
            document.getElementById('timer-bar').style.display = 'none';
        }
        
        window.scrollTo(0,0);
    }
    
    function startTimer() {
        stopTimer(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        timerRemaining = 10;
        const timerBar = document.getElementById('timer-bar');
        const timerFill = document.getElementById('timer-fill');
        timerBar.style.display = 'block';
        timerFill.style.width = '100%';
        timerFill.className = 'timer-fill';
        
        timerInterval = setInterval(() => {
            timerRemaining -= 0.1;
            const percentage = (timerRemaining / 10) * 100;
            timerFill.style.width = percentage + '%';
            
            // è­¦å‘Šè‰²ã®å¤‰æ›´
            if (percentage <= 30) {
                timerFill.className = 'timer-fill danger';
            } else if (percentage <= 50) {
                timerFill.className = 'timer-fill warning';
            }
            
            if (timerRemaining <= 0) {
                stopTimer();
                // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—å‡¦ç†
                handleTimeUp();
            }
        }, 100);
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    function handleTimeUp() {
        stopTimer();
        const q = activeQuestionList[currentQuestionIndex];
        const correct = q.formal[0];
        
        // é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–
        document.querySelectorAll('.choice-btn').forEach(b => {
            b.disabled = true;
            if (b.textContent === correct) {
                b.classList.add('correct-choice');
            }
        });
        
        // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
        const inp = document.getElementById('answer-input');
        if (inp) {
            inp.disabled = true;
            document.getElementById('solo-submit-btn').style.display = 'none';
        }
        
        // æ™‚é–“åˆ‡ã‚Œã¨ã—ã¦ä¸æ­£è§£æ‰±ã„
        const area = document.getElementById('result-area');
        const msg = document.getElementById('result-msg');
        const txt = document.getElementById('correct-text');
        area.style.display = 'block';
        txt.textContent = correct;
        playSound('wrong');
        msg.className = 'incorrect';
        msg.textContent = 'æ™‚é–“åˆ‡ã‚Œ...â°';
    }

    function setupChoice(q) {
        const con=document.getElementById('choices-container'); con.innerHTML='';
        const correct=q.formal[0];
        
        // â˜…ä¿®æ­£ï¼šã¾ãšã¯åŒã˜ã‚¸ãƒ£ãƒ³ãƒ«(type)ã‹ã‚‰èª¤ç­”å€™è£œã‚’æ¢ã™
        let pool = masterQuizData.filter(d => d.type === q.type && d.formal[0] !== correct);
        // ã‚‚ã—åŒã‚¸ãƒ£ãƒ³ãƒ«ã§å€™è£œãŒè¶³ã‚Šãªã„å ´åˆ(3ã¤æœªæº€)ã¯ã€å…¨ä½“ã‹ã‚‰æ¢ã™
        if(pool.length < 3) { pool = masterQuizData.filter(d => d.formal[0] !== correct); }

        const dummies=shuffleArray(pool).slice(0,3).map(d=>d.formal[0]);
        shuffleArray([correct, ...dummies]).forEach(c=>{
            const btn=document.createElement('button'); btn.className='choice-btn'; btn.textContent=c;
            btn.onclick=()=>checkChoice(c,btn,correct); con.appendChild(btn);
        });
    }

    function checkChoice(sel, btn, cor) {
        stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        document.querySelectorAll('.choice-btn').forEach(b=>{ b.disabled=true; if(b.textContent===cor) b.classList.add('correct-choice'); });
        const isCor=(sel===cor); if(isCor) score++; else btn.classList.add('wrong-choice');
        showResult(isCor, cor);
    }

    function setupSolo() {
        const inp=document.getElementById('answer-input'); inp.value=""; inp.disabled=false; inp.focus();
        document.getElementById('solo-submit-btn').style.display="inline-block";
    }
    function checkSoloAnswer() {
        stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        const inp=document.getElementById('answer-input'); const u=inp.value.replace(/[\sã€€ãƒ»]/g,"").toLowerCase();
        const cors=activeQuestionList[currentQuestionIndex].formal;
        const isCor=cors.some(c=>c.replace(/[\sã€€ãƒ»]/g,"").toLowerCase()===u);
        inp.disabled=true; document.getElementById('solo-submit-btn').style.display="none";
        if(isCor) score++;
        showResult(isCor, cors[0]);
    }

    function revealPartyAnswer() {
        const q=activeQuestionList[currentQuestionIndex];
        document.getElementById('party-correct-text').textContent=q.formal[0];
        document.getElementById('party-alt-text').textContent=(q.formal.length>1)?q.formal.slice(1).join(', '):"-";
        document.getElementById('party-reveal-btn').style.display="none";
        document.getElementById('party-answer-box').style.display="block";
        playSound('correct');
    }

    function showResult(isCor, ans) {
        stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        const area=document.getElementById('result-area'), msg=document.getElementById('result-msg'), txt=document.getElementById('correct-text');
        area.style.display="block"; txt.textContent=ans;
        if(isCor) { playSound('correct'); msg.className="correct"; msg.textContent="æ­£è§£ï¼â­•ï¸"; }
        else { playSound('wrong'); msg.className="incorrect"; msg.textContent="æ®‹å¿µ...âŒ"; }
    }

    function nextQuestion() {
        stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆ
        currentQuestionIndex++;
        if(currentQuestionIndex<activeQuestionList.length) showQuestion();
        else {
            stopTimer(); // æœ€çµ‚ç¢ºèª
            gameScreen.classList.remove('active'); endScreen.classList.add('active');
            if(currentPlayMode!=='party') {
                document.getElementById('scored-end-area').style.display='block';
                document.getElementById('final-score').textContent=score;
                document.getElementById('total-count').textContent=activeQuestionList.length;
                
                // çµŒé¨“å€¤è¨ˆç®—ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
                const totalQuestions = activeQuestionList.length;
                let expGained = score * 20; // æ­£è§£æ•° Ã— 20pt
                if(score === totalQuestions && totalQuestions > 0) {
                    expGained += 50; // å…¨å•æ­£è§£ãƒœãƒ¼ãƒŠã‚¹ +50pt
                }
                
                const { leveledUp } = addExp(expGained);
                updateEndLevelUI(expGained, leveledUp);
                updateLevelUI(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã®UIã‚‚æ›´æ–°
            } else {
                document.getElementById('scored-end-area').style.display='none';
            }
        }
    }

    /* ä½œæˆæ©Ÿèƒ½ */
    function showCreateScreen() {
        menuScreen.classList.remove('active');
        createScreen.classList.add('active');
    }
    function addQuestionRow() {
        const row=document.createElement('div'); row.className='q-input-row';
        row.innerHTML=`<input type="text" placeholder="ç•¥èª" class="q-abbr" style="flex:1;"><input type="text" placeholder="æ­£è§£" class="q-formal" style="flex:2;"><button class="remove-q-btn" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('q-input-container').appendChild(row);
    }
    async function submitQuizToGithub() {
        const gName=document.getElementById('c-genre-name').value;
        const gKey=document.getElementById('c-genre-key').value.toLowerCase().replace(/[^a-z]/g,'');
        const cP=document.getElementById('c-color-p').value; const cB=document.getElementById('c-color-b').value;
        
        if(!gName||!gKey) return alert("ã‚¸ãƒ£ãƒ³ãƒ«åã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const qRows=document.querySelectorAll('.q-input-row');
        const qs=[];
        qRows.forEach(r=>{
            const a=r.querySelector('.q-abbr').value; const f=r.querySelector('.q-formal').value;
            if(a&&f) qs.push({ abbr:a, formal:[f], level:1 });
        });
        if(qs.length===0) return alert("å°‘ãªãã¨ã‚‚1ã¤ã®å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const loading=document.getElementById('create-loading');
        loading.style.display="flex";

        try {
            const res = await fetch('/api/submit', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ genreKey:gKey, genreName:gName, colorPrimary:cP, colorBg:cB, questions:qs })
            });
            if(!res.ok) throw new Error((await res.json()).error || "Error");
            const data = await res.json();
            alert("âœ… é€ä¿¡å®Œäº†ï¼\nã‚ãªãŸã®ä½œã£ãŸã‚¯ã‚¤ã‚ºãŒPull Requestã¨ã—ã¦é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚\nç®¡ç†è€…ãŒæ‰¿èªã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚");
            window.location.href = data.url; 
        } catch(e) {
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        } finally {
            loading.style.display="none";
        }
    }

    /* ã‚·ã‚§ã‚¢æ©Ÿèƒ½ */
    function shareResultOnX() {
        const score = document.getElementById('final-score').textContent;
        const total = document.getElementById('total-count').textContent;
        const lv = userLevel; // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«å¤‰æ•°
        
        // æŠ•ç¨¿ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        const text = `ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚ºã§ ${score}/${total} å•æ­£è§£ã—ã¾ã—ãŸï¼\nç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«: Lv.${lv}\n#ç•¥èªã‚¯ã‚¤ã‚º #å€‹äººé–‹ç™º`;
        
        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URL (å…¬é–‹æ™‚ã¯å®Ÿéš›ã®URLã«æ›¸ãæ›ã‚ã‚Šã¾ã™)
        const url = window.location.href;
        
        // Xã®æŠ•ç¨¿ç”»é¢ã‚’é–‹ãURLã‚’ä½œæˆ
        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
        
        // åˆ¥ã‚¿ãƒ–ã§é–‹ã
        window.open(shareUrl, '_blank');
    }
    
    document.addEventListener("keypress", (e)=>{
        if(e.key==="Enter" && currentPlayMode==='solo') {
            const btn=document.getElementById('solo-submit-btn');
            if(btn.style.display!=='none') checkSoloAnswer();
            else if(document.getElementById('result-area').style.display!=='none') nextQuestion();
        }
    });

    /* --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  --- */
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwERimGKxGeeAzldV23rvo4vWJhdNmeFnecgamXPViEUcO0OHGxhclwLvG3SSZwMJ5NOw/exec";

    function openRanking() {
        document.getElementById('ranking-modal').style.display = 'flex';
        fetchRanking();
    }
    
    function closeRanking() {
        document.getElementById('ranking-modal').style.display = 'none';
    }

    async function fetchRanking() {
        const list = document.getElementById('ranking-list');
        const loading = document.getElementById('ranking-loading');
        list.innerHTML = '';
        loading.style.display = 'block';

        try {
            const res = await fetch(GAS_API_URL);
            const data = await res.json();
            
            loading.style.display = 'none';
            if(data.length === 0) {
                list.innerHTML = '<p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            data.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `ranking-item rank-${index + 1}`;
                li.innerHTML = `
                    <span class="rank-num">${index + 1}</span>
                    <span class="rank-name">${escapeHtml(item.name)}</span>
                    <span class="rank-score">${item.score}å•</span>
                `;
                list.appendChild(li);
            });
        } catch(e) {
            loading.textContent = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
            console.error(e);
        }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åå‰ã‚’å¾©å…ƒ
    document.addEventListener('DOMContentLoaded', () => {
        const savedName = localStorage.getItem('quizPlayerName');
        if(savedName) {
            const input = document.getElementById('player-name');
            if(input) input.value = savedName;
        }
    });

    async function registerScore() {
        const name = document.getElementById('player-name').value;
        const scoreVal = document.getElementById('final-score').textContent; // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢
        
        if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(scoreVal == 0) return alert("0ç‚¹ã®è¨˜éŒ²ã¯ç™»éŒ²ã§ãã¾ã›ã‚“");

        const btn = document.querySelector('#register-area button');
        btn.disabled = true; btn.textContent = "é€ä¿¡ä¸­...";

        localStorage.setItem('quizPlayerName', name);

        try {
            // CORSå›é¿ã®ãŸã‚ã€no-corsã§ã¯ãªãredirectã‚’åˆ©ç”¨ã™ã‚‹ã‹ã€å˜ç´”ãªPOSTã‚’é€ã‚‹
            // GASå´ã§ContentService.createTextOutputã‚’è¿”ã—ã¦ã„ã‚Œã°fetchã§å—ã‘å–ã‚Œã‚‹
            await fetch(GAS_API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain" }, // â˜…ã“ã‚Œã‚’è¿½åŠ ã—ã¦æ˜ç¤ºçš„ã«ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦é€ã‚‹
                body: JSON.stringify({ name: name, score: scoreVal })
            });
            
            alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
            document.getElementById('register-area').style.display = 'none'; // ç™»éŒ²ã‚¨ãƒªã‚¢ã‚’éš ã™
            openRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã‚’é–‹ã
        } catch(e) {
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
            btn.disabled = false; btn.textContent = "é€ä¿¡";
        }
    }

    // XSSå¯¾ç­–
    function escapeHtml(str) {
        if(!str) return "";
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
</script>
</body>
</html>
