<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚ºï¼ˆAIç„¡é™ç”Ÿæˆç‰ˆï¼‰</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --bg-color: #f0f4f8;
            --text-color: #333;
            
            /* ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚«ãƒ©ãƒ¼ */
            --ai-primary: #8e44ad; /* AI Purple */
            --ai-bg: #f3e5f5;
            
            --gal-primary: #ff69b4;
            --gal-bg: #fff0f5;
            --police-primary: #2c3e50;
            --police-bg: #e8ecef;
            --biz-primary: #0047AB; 
            --biz-bg: #f5f7fa;
            --otaku-primary: #9b59b6;
            --otaku-bg: #f3e5f5;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s;
        }

        body.ai-mode { background-color: var(--ai-bg); --primary-color: var(--ai-primary); }
        body.gal-mode { background-color: var(--gal-bg); --primary-color: var(--gal-primary); }
        body.police-mode { background-color: var(--police-bg); --primary-color: var(--police-primary); }
        body.biz-mode { background-color: var(--biz-bg); --primary-color: var(--biz-primary); }
        body.otaku-mode { background-color: var(--otaku-bg); --primary-color: var(--otaku-primary); }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        h1 { color: #2c3e50; margin-bottom: 0.5rem; font-size: 1.5rem; }
        .subtitle { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1.5rem; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin: 8px 0; padding: 1rem; font-size: 1rem;
            border-radius: 12px; border: none; cursor: pointer;
            transition: transform 0.1s; font-weight: bold; color: white;
            text-align: left; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-desc { font-size: 0.75rem; font-weight: normal; margin-top: 2px; opacity: 0.9; display:block; }

        .btn-std { background-color: #3498db; }
        .btn-police { background-color: #2c3e50; border-left: 5px solid #f1c40f; }
        .btn-biz { background-color: #0047AB; }
        .btn-otaku { background-color: #9b59b6; }
        .btn-gal { background-color: #ff69b4; }
        
        /* AIãƒœã‚¿ãƒ³ */
        .btn-ai { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 0 #5a3b7e;
        }

        /* APIã‚­ãƒ¼è¨­å®š */
        .api-settings {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .api-input {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;
        }

        .play-mode-selector { display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .play-mode-btn {
            padding: 8px 14px; border: 1px solid #ccc; border-radius: 20px;
            background: white; cursor: pointer; font-size: 0.85rem;
        }
        .play-mode-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .era-btn {
            width: 100%; margin: 5px 0; padding: 0.8rem; font-size: 0.9rem;
            border-radius: 50px; border: 2px solid #ff69b4;
            background: white; color: #ff69b4; font-weight: bold; cursor: pointer;
        }

        .question-box {
            background-color: #eef2f7; padding: 1.5rem; border-radius: 10px;
            margin-bottom: 1.5rem; min-height: 140px; display: flex;
            flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        .badge {
            position: absolute; top: -10px; right: 10px; color: #fff;
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .abbr-text { font-size: 2.0rem; font-weight: bold; color: var(--primary-color); margin: 0; line-height: 1.2; }

        .choices-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .choice-btn {
            background-color: white; border: 2px solid #bdc3c7; color: #333;
            padding: 14px; font-size: 0.95rem; border-radius: 10px;
            cursor: pointer; font-weight: bold; transition: all 0.2s;
            overflow-wrap: break-word; word-wrap: break-word;
        }
        .choice-btn.correct-choice { background-color: var(--success-color) !important; color: white !important; border-color: var(--success-color) !important; }
        .choice-btn.wrong-choice { background-color: var(--error-color) !important; color: white !important; border-color: var(--error-color) !important; }

        .action-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 14px 20px; font-size: 1.1rem; border-radius: 50px;
            cursor: pointer; font-weight: bold; width: 100%; max-width: 300px;
            box-shadow: 0 4px 0 var(--primary-dark); margin-top: 10px;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        input[type="text"] {
            width: 100%; padding: 14px; font-size: 1.2rem; border: 2px solid #ddd;
            border-radius: 8px; margin-bottom: 1rem; text-align: center; outline: none;
        }
        
        .result-feedback-box {
            background: #fafafa; padding: 20px; border-radius: 10px;
            margin-top: 10px; text-align: center; border: 1px solid #eee;
        }
        #result-message { font-size: 1.6rem; font-weight: bold; margin: 0.5rem 0; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }

        .progress-container { width: 100%; background-color: #eee; height: 6px; border-radius: 3px; margin-bottom: 1.5rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--success-color); width: 0%; transition: width 0.3s; }
        .back-link { display: inline-block; margin-top: 25px; color: #999; text-decoration: underline; cursor: pointer; font-size: 0.9rem; padding: 10px; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            border-radius: 16px; z-index: 10;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.3rem; }
            .abbr-text { font-size: 1.6rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="app-title">ç•¥èªæ­£å¼åç§°ã‚¯ã‚¤ã‚º</h1>
    <p class="subtitle">AIãªã‚‰å•é¡Œã¯ç„¡é™å¤§ï¼<br>APIã‚­ãƒ¼ã‚’å…¥ã‚Œã¦éŠã‚“ã§ã­</p>

    <div id="menu-screen" class="screen active">
        
        <div style="margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">éŠã³æ–¹</p>
            <div class="play-mode-selector">
                <button class="play-mode-btn selected" onclick="setPlayMode('choice', this)">ğŸ¤” 4æŠ</button>
                <button class="play-mode-btn" onclick="setPlayMode('solo', this)">âŒ¨ï¸ å…¥åŠ›</button>
                <button class="play-mode-btn" onclick="setPlayMode('party', this)">ğŸ—£ï¸ ã¿ã‚“ãª</button>
            </div>
        </div>

        <div style="height: 320px; overflow-y: auto; padding-right: 5px;">
            
            <button class="menu-btn btn-ai" onclick="startAIGame()">
                <div class="menu-btn-content">
                    <span>ğŸ¤– AIç„¡é™ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰</span>
                    <span class="menu-desc">GeminiãŒãã®å ´ã§å•é¡Œä½œæˆï¼</span>
                </div>
                <span>âœ¨</span>
            </button>
            
            <p style="font-size:0.9rem; font-weight:bold; margin:15px 0 5px;">é€šå¸¸ã‚³ãƒ¼ã‚¹ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰</p>

            <button class="menu-btn btn-std" onclick="startSpecialGame('std')">
                <div class="menu-btn-content">
                    <span>ğŸ“˜ ä¸€èˆ¬å¸¸è­˜ã‚³ãƒ¼ã‚¹</span>
                    <span class="menu-desc">ãƒ¬ãƒ™ãƒ«é †ã«ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-police" onclick="startSpecialGame('police')">
                <div class="menu-btn-content">
                    <span>ğŸ‘® è­¦å¯Ÿãƒ»åˆ‘äº‹ãƒ‰ãƒ©ãƒ</span>
                    <span class="menu-desc">ãƒ‡ã‚«ã€ã‚¬ã‚µå…¥ã‚Œ...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-biz" onclick="startSpecialGame('biz')">
                <div class="menu-btn-content">
                    <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ»IT</span>
                    <span class="menu-desc">MTGã€ã‚¢ã‚¸ã‚§ãƒ³ãƒ€...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-otaku" onclick="startSpecialGame('otaku')">
                <div class="menu-btn-content">
                    <span>ğŸ¤“ ã‚ªã‚¿ã‚¯ãƒ»æ¨ã—æ´»</span>
                    <span class="menu-desc">å°Šã„ã€åŒæ‹…ã€ROMå°‚...</span>
                </div>
                <span>â–¶</span>
            </button>

            <button class="menu-btn btn-gal" onclick="toggleGalMenu()">
                <div class="menu-btn-content">
                    <span>ğŸ’– ã‚®ãƒ£ãƒ«èªãƒ»æ­»èª</span>
                    <span class="menu-desc">æ˜­å’Œãƒ»å¹³æˆãƒ»ä»¤å’Œ</span>
                </div>
                <span>â–¼</span>
            </button>
            
            <div id="gal-era-select" style="display:none; margin-top:5px; animation: fadeIn 0.3s;">
                <button class="era-btn" onclick="startGalGame('showa')">ğŸ“¼ æ˜­å’Œã‚®ãƒ£ãƒ«</button>
                <button class="era-btn" onclick="startGalGame('heisei')">ğŸŒº å¹³æˆã‚®ãƒ£ãƒ«</button>
                <button class="era-btn" onclick="startGalGame('reiwa')">ğŸ“± ä»¤å’Œã‚®ãƒ£ãƒ«</button>
            </div>

            <div class="api-settings">
                <div style="font-weight:bold; margin-bottom:5px;">âš™ï¸ Gemini APIè¨­å®š</div>
                <div style="font-size:0.8rem; color:#666;">AIãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã†ã«ã¯ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ï¼‰</div>
                <input type="password" id="api-key-input" class="api-input" placeholder="AIzaSy..." onchange="saveApiKey()">
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <p>AIãŒå•é¡Œã‚’è€ƒãˆã¦ã„ã¾ã™...<br>ï¼ˆæ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</p>
        </div>

        <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
        
        <div class="question-box">
            <div id="info-badge" class="badge" style="background:#ccc;">CATEGORY</div>
            <span class="label" id="question-label">ã“ã‚Œã®æ­£å¼åç§°ï¼ˆæ„å‘³ï¼‰ã¯ï¼Ÿ</span>
            <div id="question-text" class="abbr-text"></div>
        </div>

        <div id="choice-area" style="display:none;">
            <div id="choices-container" class="choices-container"></div>
        </div>

        <div id="solo-area" style="display:none;">
            <input type="text" id="answer-input" placeholder="ã“ã“ã«å…¥åŠ›..." autocomplete="off">
            <br>
            <button id="solo-submit-btn" class="action-btn" onclick="checkSoloAnswer()">å›ç­”ã™ã‚‹</button>
        </div>

        <div id="common-result-area" class="result-feedback-box" style="display:none;">
            <div id="result-message"></div>
            <div style="margin-top:10px;">
                æ­£è§£ã¯ï¼š<br><strong id="common-correct-text" style="font-size:1.3rem; color:#333;"></strong>
            </div>
            <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
        </div>

        <div id="party-area" style="display:none;">
            <button id="party-reveal-btn" class="action-btn" style="background-color:#e67e22; box-shadow: 0 4px 0 #d35400;" onclick="revealPartyAnswer()">æ­£è§£ã‚’è¦‹ã‚‹</button>
            <div id="party-answer-box" style="display:none; margin:20px 0; border:2px dashed #ccc; padding:20px;">
                <div id="party-correct-text" style="font-size:1.6rem; font-weight:bold; color:#e74c3c;"></div>
                <div style="color:#777; margin-top:5px;">ï¼ˆä»–ï¼š<span id="party-alt-text"></span>ï¼‰</div>
                <br>
                <button class="action-btn" onclick="nextQuestion()">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <div class="back-link" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</div>
    </div>

    <div id="end-screen" class="screen">
        <h2 id="end-title">çµ‚äº†ï¼</h2>
        <div id="scored-end-area">
            <p style="font-size:1.5rem; font-weight:bold;">æ­£è§£æ•°: <span id="final-score">0</span> / <span id="total-count">0</span></p>
            <div id="feedback-comment" style="margin: 1.5rem 0; font-size:1.1rem;"></div>
        </div>
        
        <button id="ai-reload-btn" class="action-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:none; margin-bottom:10px;" onclick="startAIGame()">
            âœ¨ é•ã†å•é¡Œã‚’ç”Ÿæˆã™ã‚‹
        </button>

        <button class="action-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    /* --- åŸºæœ¬è¨­å®š --- */
    let audioCtx;
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSound(type) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        if (type === 'correct') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
        }
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now); osc.stop(now+0.4);
    }

    /* --- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨) --- */
    const masterQuizData = [
        { abbr: "ã‚¹ãƒãƒ›", formal: ["ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"], type: 'std', level: 1 },
        { abbr: "ãƒ‘ã‚½ã‚³ãƒ³", formal: ["ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"], type: 'std', level: 1 },
        { abbr: "é£Ÿãƒ‘ãƒ³", formal: ["ä¸»é£Ÿç”¨ãƒ‘ãƒ³"], type: 'std', level: 2 },
        { abbr: "è»æ‰‹", formal: ["è»ç”¨æ‰‹è¢‹"], type: 'std', level: 2 },
        { abbr: "ã‚«ãƒ©ã‚ªã‚±", formal: ["ç©ºã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©"], type: 'std', level: 3 },
        { abbr: "ãƒ‰ã‚¿ã‚­ãƒ£ãƒ³", formal: ["åœŸå£‡å ´ã‚­ãƒ£ãƒ³ã‚»ãƒ«"], type: 'std', level: 3 },
        { abbr: "ã‚¬ã‚µå…¥ã‚Œ", formal: ["æœç´¢å·®æŠ¼"], type: 'police', level: 1 },
        { abbr: "ãƒ‡ã‚«", formal: ["åˆ‘äº‹"], type: 'police', level: 1 },
        { abbr: "OJT", formal: ["On-the-Job Training"], type: 'biz', level: 1 },
        { abbr: "MTG", formal: ["ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°"], type: 'biz', level: 1 },
        { abbr: "DD", formal: ["èª°ã§ã‚‚å¤§å¥½ã"], type: 'otaku', level: 1 },
        { abbr: "ãƒŠã‚¦ã„", formal: ["ç¾ä»£çš„"], type: 'gal', era: 'showa' },
        { abbr: "KP", formal: ["ä¹¾æ¯"], type: 'gal', era: 'reiwa' }
        // â€»å®¹é‡çœç•¥ã®ãŸã‚ä¸€éƒ¨ã®ã¿è¨˜è¼‰ã—ã¦ã„ã¾ã™ãŒã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾æ®‹ã—ã¦ãã ã•ã„
    ];

    /* --- çŠ¶æ…‹å¤‰æ•° --- */
    let currentPlayMode = 'choice'; 
    let currentType = 'std'; 
    let activeQuestionList = [];
    let currentQuestionIndex = 0;
    let score = 0;

    // DOMå–å¾—
    const menuScreen = document.getElementById('menu-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const questionText = document.getElementById('question-text');
    const infoBadge = document.getElementById('info-badge');
    const loadingOverlay = document.getElementById('loading-overlay');
    const apiKeyInput = document.getElementById('api-key-input');

    // APIã‚­ãƒ¼èª­ã¿è¾¼ã¿
    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if(savedKey) apiKeyInput.value = savedKey;
    };
    function saveApiKey() {
        localStorage.setItem('gemini_api_key', apiKeyInput.value.trim());
    }

    function setPlayMode(mode, btn) {
        currentPlayMode = mode;
        document.querySelectorAll('.play-mode-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function toggleGalMenu() {
        const m = document.getElementById('gal-era-select');
        m.style.display = (m.style.display==='none')?'block':'none';
    }
    function shuffleArray(arr) {
        for(let i=arr.length-1; i>0; i--){
            const j=Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    /* --- AIç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ --- */
    async function startAIGame() {
        const apiKey = apiKeyInput.value.trim();
        if(!apiKey) {
            alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nï¼ˆGoogle AI Studioã§ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ï¼‰");
            return;
        }

        initAudio();
        loadingOverlay.style.display = "flex";
        currentType = 'ai';
        document.body.className = 'ai-mode';
        
        try {
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
            const prompt = `
            ã‚ãªãŸã¯ã‚¯ã‚¤ã‚ºä½œæˆAIã§ã™ã€‚
            ã€Œç•¥èªã®æ­£å¼åç§°ã‚¯ã‚¤ã‚ºã€ã¾ãŸã¯ã€Œæ¥­ç•Œç”¨èªã®æ„å‘³ã‚¯ã‚¤ã‚ºã€ã‚’æ–°ã—ã5å•ä½œæˆã—ã€JSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            
            ã€æ¡ä»¶ã€‘
            1. ä¸€èˆ¬çš„ãªç•¥èªã€ãƒ“ã‚¸ãƒã‚¹ç”¨èªã€ITç”¨èªã€è‹¥è€…è¨€è‘‰ã€æ¥­ç•Œéš èªãªã©ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ã“ã¨ã€‚
            2. å›ç­”ã¯å¿…ãšæœ‰åŠ¹ãªJSONé…åˆ—ã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ï¼ˆMarkdownã®backtickãªã©ã¯ä¸è¦ï¼‰ã€‚
            3. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
            [
              { "abbr": "ç•¥èªã¾ãŸã¯ç”¨èª", "formal": ["æ­£å¼åç§°1", "æ­£å¼åç§°2(ã‚ã‚Œã°)"], "level": 1ã€œ3ã®é›£æ˜“åº¦ }
            ]
            4. æ—¢å­˜ã®ã‚ˆãã‚ã‚‹å•é¡Œã ã‘ã§ãªãã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚‚ã®ã‚‚æ··ãœã¦ãã ã•ã„ã€‚
            `;

            // APIã‚³ãƒ¼ãƒ«
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) throw new Error("API Error");

            const data = await response.json();
            let rawText = data.candidates[0].content.parts[0].text;
            
            // JSONã®æ•´å½¢ï¼ˆMarkdownè¨˜æ³•ã®é™¤å»ï¼‰
            rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            const aiQuestions = JSON.parse(rawText);

            // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ï¼ˆtypeä»˜ä¸ï¼‰
            aiQuestions.forEach(q => q.type = 'ai');
            
            activeQuestionList = aiQuestions;
            loadingOverlay.style.display = "none";
            startGameCommon();

        } catch (e) {
            loadingOverlay.style.display = "none";
            console.error(e);
            alert("å•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nAPIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã™ã‚‹ã‹ã€æ™‚é–“ã‚’ç½®ã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚\n(ã‚¨ãƒ©ãƒ¼: " + e.message + ")");
        }
    }

    /* --- é€šå¸¸ã‚²ãƒ¼ãƒ é–‹å§‹ --- */
    function startSpecialGame(type) {
        initAudio();
        currentType = type;
        document.body.className = ''; 
        if(type === 'police') document.body.classList.add('police-mode');
        else if(type === 'biz') document.body.classList.add('biz-mode');
        else if(type === 'otaku') document.body.classList.add('otaku-mode');

        const targetData = masterQuizData.filter(q => q.type === type);
        // ç°¡æ˜“ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        activeQuestionList = shuffleArray(targetData).slice(0, 10);
        
        if(activeQuestionList.length === 0) activeQuestionList = masterQuizData.slice(0,5); // fallback
        startGameCommon();
    }

    function startGalGame(era) {
        initAudio();
        currentType = 'gal';
        document.body.className = 'gal-mode';
        const targetData = masterQuizData.filter(q => q.type === 'gal' && q.era === era);
        activeQuestionList = shuffleArray(targetData).slice(0, 10);
        startGameCommon();
    }

    function startGameCommon() {
        currentQuestionIndex = 0;
        score = 0;
        menuScreen.classList.remove('active');
        gameScreen.classList.add('active');
        endScreen.classList.remove('active');
        
        document.getElementById('choice-area').style.display = (currentPlayMode==='choice')?'block':'none';
        document.getElementById('solo-area').style.display = (currentPlayMode==='solo')?'block':'none';
        document.getElementById('party-area').style.display = (currentPlayMode==='party')?'block':'none';
        
        showQuestion();
    }

    /* --- è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ --- */
    function showQuestion() {
        const q = activeQuestionList[currentQuestionIndex];
        questionText.textContent = q.abbr;
        
        infoBadge.textContent = getBadgeText(q);
        infoBadge.style.backgroundColor = getBadgeColor(q);

        document.getElementById('progress-bar').style.width = `${(currentQuestionIndex/activeQuestionList.length)*100}%`;
        document.getElementById('common-result-area').style.display = "none";
        document.getElementById('party-answer-box').style.display = "none";
        document.getElementById('party-reveal-btn').style.display = "inline-block";

        if(currentPlayMode==='choice') setupChoiceMode(q);
        else if(currentPlayMode==='solo') setupSoloMode();
        window.scrollTo(0,0);
    }

    function getBadgeText(q) {
        if(currentType === 'ai') return "AIç”Ÿæˆå•";
        if(currentType === 'gal') return (q.era==='showa')?"æ˜­å’Œ":(q.era==='heisei')?"å¹³æˆ":"ä»¤å’Œ";
        return "LEVEL " + (q.level || "?");
    }
    function getBadgeColor(q) {
        if(currentType === 'ai') return "#8e44ad";
        if(currentType === 'police') return "#f1c40f";
        if(currentType === 'biz') return "#003366";
        if(currentType === 'otaku') return "#8e44ad";
        if(currentType === 'gal') return "#ff69b4";
        return (q.level===1)?"#27ae60":(q.level===2)?"#e67e22":"#e74c3c";
    }

    // --- 4æŠ ---
    function setupChoiceMode(q) {
        const con = document.getElementById('choices-container');
        con.innerHTML = '';
        const correct = q.formal[0];
        
        // ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ç”Ÿæˆ
        // AIãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å–ã‚‹
        let pool = masterQuizData.filter(d => d.formal[0] !== correct);
        const dummies = shuffleArray(pool).slice(0,3).map(d => d.formal[0]);
        let choices = shuffleArray([correct, ...dummies]);

        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = c;
            btn.onclick = ()=>checkChoice(c, btn, correct);
            con.appendChild(btn);
        });
    }

    function checkChoice(sel, btn, cor) {
        document.querySelectorAll('.choice-btn').forEach(b=>{
            b.disabled=true;
            if(b.textContent===cor) b.classList.add('correct-choice');
        });
        const isCor = (sel===cor);
        if(isCor) score++;
        else btn.classList.add('wrong-choice');
        showResult(isCor, cor);
    }

    // --- å…¥åŠ› ---
    function setupSoloMode() {
        const inp = document.getElementById('answer-input');
        inp.value = ""; inp.disabled=false; inp.focus();
        document.getElementById('solo-submit-btn').style.display="inline-block";
    }
    function checkSoloAnswer() {
        const inp = document.getElementById('answer-input');
        const user = inp.value.replace(/[\sã€€ãƒ»]/g,"").toLowerCase();
        const cors = activeQuestionList[currentQuestionIndex].formal;
        const isCor = cors.some(c=>c.replace(/[\sã€€ãƒ»]/g,"").toLowerCase() === user);
        inp.disabled=true;
        document.getElementById('solo-submit-btn').style.display="none";
        if(isCor) score++;
        showResult(isCor, cors[0]);
    }

    // --- ã¿ã‚“ãª ---
    function revealPartyAnswer() {
        const q = activeQuestionList[currentQuestionIndex];
        document.getElementById('party-correct-text').textContent = q.formal[0];
        document.getElementById('party-alt-text').textContent = (q.formal.length>1)?q.formal.slice(1).join(', '):"-";
        document.getElementById('party-reveal-btn').style.display="none";
        document.getElementById('party-answer-box').style.display="block";
        playSound('correct');
    }

    // --- çµæœ ---
    function showResult(isCor, ans) {
        const area = document.getElementById('common-result-area');
        const msg = document.getElementById('result-message');
        const corTxt = document.getElementById('common-correct-text');
        area.style.display="block";
        corTxt.textContent = ans;

        if(isCor) {
            playSound('correct');
            msg.className = "correct";
            msg.textContent = (currentType==='ai')?"AIã‚‚æ„Ÿå¿ƒã—ã¦ã¾ã™ï¼":"æ­£è§£ï¼â­•ï¸";
        } else {
            playSound('wrong');
            msg.className = "incorrect";
            msg.textContent = "æ®‹å¿µ...âŒ";
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if(currentQuestionIndex < activeQuestionList.length) showQuestion();
        else showEndScreen();
    }

    function showEndScreen() {
        gameScreen.classList.remove('active');
        endScreen.classList.add('active');
        
        // AIãƒ¢ãƒ¼ãƒ‰ãªã‚‰å†ç”Ÿæˆãƒœã‚¿ãƒ³è¡¨ç¤º
        const aiBtn = document.getElementById('ai-reload-btn');
        aiBtn.style.display = (currentType === 'ai') ? 'inline-block' : 'none';

        if(currentPlayMode !== 'party') {
            document.getElementById('scored-end-area').style.display='block';
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-count').textContent = activeQuestionList.length;
            document.getElementById('feedback-comment').textContent = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼";
        } else {
            document.getElementById('scored-end-area').style.display='none';
        }
    }

    document.addEventListener("keypress", (e)=>{
        if(e.key==="Enter" && currentPlayMode==='solo') {
            const btn = document.getElementById('solo-submit-btn');
            if(btn.style.display!=='none') checkSoloAnswer();
            else if(document.getElementById('common-result-area').style.display!=='none') nextQuestion();
        }
    });
</script>
</body>
</html>
